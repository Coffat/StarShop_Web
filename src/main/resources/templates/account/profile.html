<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layouts/main :: layout('Thông tin tài khoản', 
          'Quản lý thông tin tài khoản StarShop của bạn. Cập nhật thông tin cá nhân, địa chỉ giao hàng và cài đặt bảo mật.',
          ~{::link},
          ~{::content})}">

<head>
    <link rel="stylesheet" href="/css/account.css">
</head>

<body>
<th:block th:fragment="content">
    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <div class="header-content">
                <div class="breadcrumb-wrapper">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/" class="breadcrumb-link">
                                    <i class="bi bi-house"></i>
                                    Trang chủ
                                </a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Thông tin tài khoản</li>
                        </ol>
                    </nav>
                </div>
                <div class="page-title-section">
                    <h1 class="page-title">
                        <span class="title-icon">
                            <i class="bi bi-person-circle"></i>
                        </span>
                        Thông tin tài khoản
                    </h1>
                    <p class="page-subtitle">Quản lý thông tin cá nhân và cài đặt tài khoản của bạn</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Account Content -->
    <section class="account-section">
        <div class="container">
            <!-- Success/Error Messages -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            
            <div class="row g-4">
                
                <!-- Sidebar Navigation -->
                <div class="col-lg-3">
                    <div class="account-sidebar">
                        <!-- User Profile Card -->
                        <div class="profile-card">
                            <div class="profile-avatar">
                                <div class="avatar-circle">
                                    <img th:if="${userObject != null and userObject.avatar != null}" 
                                         th:src="${userObject.avatar}" 
                                         alt="Avatar" 
                                         style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                                    <i th:if="${userObject == null or userObject.avatar == null}" class="bi bi-person-fill" style="display: inline-block;"></i>
                                    <i class="bi bi-person-fill" style="display: none;"></i>
                                </div>
                                <div class="avatar-status">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                            </div>
                            <div class="profile-info">
                                <h3 class="profile-name" th:text="${userObject != null ? userObject.fullName : 'Người dùng'}">Người dùng</h3>
                                <p class="profile-email" th:text="${userObject != null ? userObject.email : currentUser}">user@example.com</p>
                                <span class="profile-badge">
                                    <i class="bi bi-star-fill"></i>
                                    Thành viên từ <span th:text="${memberSince ?: '2024'}">2024</span>
                                </span>
                            </div>
                        </div>

                        <!-- Navigation Menu -->
                        <nav class="account-nav">
                            <ul class="nav-list">
                                <li class="nav-item">
                                    <a href="/account/profile" class="nav-link active">
                                        <span class="nav-icon">
                                            <i class="bi bi-person"></i>
                                        </span>
                                        <span class="nav-text">Thông tin cá nhân</span>
                                        <span class="nav-arrow">
                                            <i class="bi bi-chevron-right"></i>
                                        </span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/account/orders" class="nav-link">
                                        <span class="nav-icon">
                                            <i class="bi bi-bag"></i>
                                        </span>
                                        <span class="nav-text">Đơn hàng của tôi</span>
                                        <span class="nav-badge" th:text="${ordersCount}" th:if="${ordersCount > 0}">3</span>
                                        <span class="nav-arrow">
                                            <i class="bi bi-chevron-right"></i>
                                        </span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/account/wishlist" class="nav-link">
                                        <span class="nav-icon">
                                            <i class="bi bi-heart"></i>
                                        </span>
                                        <span class="nav-text">Yêu thích</span>
                                        <span class="nav-badge" th:text="${wishlistCount}" th:if="${wishlistCount > 0}">12</span>
                                        <span class="nav-arrow">
                                            <i class="bi bi-chevron-right"></i>
                                        </span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/account/settings" class="nav-link">
                                        <span class="nav-icon">
                                            <i class="bi bi-gear"></i>
                                        </span>
                                        <span class="nav-text">Cài đặt</span>
                                        <span class="nav-arrow">
                                            <i class="bi bi-chevron-right"></i>
                                        </span>
                                    </a>
                                </li>
                                <li class="nav-divider"></li>
                                <li class="nav-item">
                                    <a href="/logout" class="nav-link logout-link">
                                        <span class="nav-icon">
                                            <i class="bi bi-box-arrow-right"></i>
                                        </span>
                                        <span class="nav-text">Đăng xuất</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <div class="account-content">
                        
                        <!-- Profile Information -->
                        <div class="content-card">
                            <div class="card-header">
                                <h2 class="card-title">
                                    <i class="bi bi-person-lines-fill"></i>
                                    Thông tin cá nhân
                                </h2>
                                <button class="btn-edit" type="button" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                    <i class="bi bi-pencil"></i>
                                    Chỉnh sửa
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label class="info-label">Họ và tên</label>
                                        <div class="info-value" th:text="${userObject != null ? userObject.fullName : 'Chưa cập nhật'}">Chưa cập nhật</div>
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label">Email</label>
                                        <div class="info-value" th:text="${userObject != null ? userObject.email : currentUser}">user@example.com</div>
                                        <span class="info-status verified">
                                            <i class="bi bi-check-circle-fill"></i>
                                            Đã xác thực
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label">Số điện thoại</label>
                                        <div class="info-value" th:text="${userObject != null and userObject.phone != null ? userObject.phone : 'Chưa cập nhật'}">Chưa cập nhật</div>
                                        <span class="info-status verified" th:if="${userObject != null and userObject.phone != null}">
                                            <i class="bi bi-check-circle-fill"></i>
                                            Đã xác thực
                                        </span>
                                        <span class="info-status unverified" th:if="${userObject == null or userObject.phone == null}">
                                            <i class="bi bi-exclamation-circle"></i>
                                            Chưa xác thực
                                        </span>
                                    </div>
                                    <div class="info-item full-width">
                                        <label class="info-label">Địa chỉ giao hàng</label>
                                        <div class="info-value" th:text="${userAddress ?: 'Chưa cập nhật địa chỉ giao hàng'}">Chưa cập nhật địa chỉ giao hàng</div>
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label">Vai trò</label>
                                        <div class="info-value" th:text="${userObject != null ? userObject.role.displayName : 'Khách hàng'}">Khách hàng</div>
                                    </div>
                                    <div class="info-item">
                                        <label class="info-label">Ngày tham gia</label>
                                        <div class="info-value" th:text="${userObject != null and userObject.createdAt != null ? #temporals.format(userObject.createdAt, 'dd/MM/yyyy') : 'Không rõ'}">Không rõ</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Statistics -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon orders">
                                    <i class="bi bi-bag-check"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number" th:text="${ordersCount ?: 0}">24</div>
                                    <div class="stat-label">Đơn hàng</div>
                                    <div class="stat-trend">
                                        <i class="bi bi-arrow-up"></i>
                                        Tổng cộng
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon wishlist">
                                    <i class="bi bi-heart-fill"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number" th:text="${wishlistCount ?: 0}">12</div>
                                    <div class="stat-label">Yêu thích</div>
                                    <div class="stat-trend">
                                        <i class="bi bi-arrow-up"></i>
                                        Đã lưu
                                    </div>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-icon points">
                                    <i class="bi bi-bag-fill"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-number" th:text="${cartCount ?: 0}">0</div>
                                    <div class="stat-label">Giỏ hàng</div>
                                    <div class="stat-trend">
                                        <i class="bi bi-bag"></i>
                                        Sản phẩm
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activities -->
                        <div class="content-card">
                            <div class="card-header">
                                <h2 class="card-title">
                                    <i class="bi bi-clock-history"></i>
                                    Hoạt động gần đây
                                </h2>
                                <a href="/account/orders" class="btn-view-all" th:if="${ordersCount > 0}">
                                    Xem tất cả
                                    <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                            <div class="card-body">
                                <!-- Show when user has no activities -->
                                <div class="activity-list" th:if="${ordersCount == 0 and wishlistCount == 0}">
                                    <div class="empty-activity">
                                        <div class="empty-activity-icon">
                                            <i class="bi bi-clock-history"></i>
                                        </div>
                                        <h4 class="empty-activity-title">Chưa có hoạt động nào</h4>
                                        <p class="empty-activity-desc">
                                            Bạn chưa có đơn hàng hoặc sản phẩm yêu thích nào.<br>
                                            Hãy bắt đầu khám phá và mua sắm!
                                        </p>
                                        <a href="/products" class="btn btn-primary">
                                            <i class="bi bi-search"></i>
                                            Khám phá sản phẩm
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Show summary when user has activities -->
                                <div class="activity-list" th:if="${ordersCount > 0 or wishlistCount > 0}">
                                    <div class="activity-item" th:if="${ordersCount > 0}">
                                        <div class="activity-icon info">
                                            <i class="bi bi-bag-check"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title" th:text="'Bạn có ' + ${ordersCount} + ' đơn hàng'">Bạn có đơn hàng</div>
                                            <div class="activity-time">Xem chi tiết trong lịch sử đơn hàng</div>
                                        </div>
                                        <div class="activity-action">
                                            <a href="/account/orders" class="btn-sm-outline">Xem đơn hàng</a>
                                        </div>
                                    </div>
                                    
                                    <div class="activity-item" th:if="${wishlistCount > 0}">
                                        <div class="activity-icon warning">
                                            <i class="bi bi-heart-fill"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title" th:text="'Bạn có ' + ${wishlistCount} + ' sản phẩm yêu thích'">Bạn có sản phẩm yêu thích</div>
                                            <div class="activity-time">Xem trong danh sách yêu thích</div>
                                        </div>
                                        <div class="activity-action">
                                            <a href="/account/wishlist" class="btn-sm-outline">Xem yêu thích</a>
                                        </div>
                                    </div>
                                    
                                    <div class="activity-item" th:if="${cartCount > 0}">
                                        <div class="activity-icon success">
                                            <i class="bi bi-bag"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-title" th:text="'Bạn có ' + ${cartCount} + ' sản phẩm trong giỏ hàng'">Bạn có sản phẩm trong giỏ hàng</div>
                                            <div class="activity-time">Sẵn sàng để thanh toán</div>
                                        </div>
                                        <div class="activity-action">
                                            <a href="/cart" class="btn-sm-outline">Xem giỏ hàng</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <h3 class="actions-title">Thao tác nhanh</h3>
                            <div class="actions-grid">
                                <a href="/products" class="action-card">
                                    <div class="action-icon">
                                        <i class="bi bi-search"></i>
                                    </div>
                                    <div class="action-content">
                                        <div class="action-title">Khám phá sản phẩm</div>
                                        <div class="action-desc">Tìm hoa yêu thích</div>
                                    </div>
                                </a>
                                
                                <a href="/account/orders" class="action-card">
                                    <div class="action-icon">
                                        <i class="bi bi-repeat"></i>
                                    </div>
                                    <div class="action-content">
                                        <div class="action-title">Đặt lại đơn hàng</div>
                                        <div class="action-desc">Từ lịch sử mua hàng</div>
                                    </div>
                                </a>
                                
                                <a href="/support" class="action-card">
                                    <div class="action-icon">
                                        <i class="bi bi-headset"></i>
                                    </div>
                                    <div class="action-content">
                                        <div class="action-title">Hỗ trợ khách hàng</div>
                                        <div class="action-desc">Liên hệ với chúng tôi</div>
                                    </div>
                                </a>
                            </div>
                        </div>

                    </div>
                </div>
                
            </div>
        </div>
    </section>


    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">
                        <i class="bi bi-pencil-square"></i>
                        Chỉnh sửa thông tin
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm" action="/account/profile/update" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="row g-3">
                            <div class="col-6">
                                <label for="firstName" class="form-label">Tên</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" th:value="${userObject != null ? userObject.firstname : ''}" placeholder="Nhập tên" required>
                            </div>
                            <div class="col-6">
                                <label for="lastName" class="form-label">Họ</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" th:value="${userObject != null ? userObject.lastname : ''}" placeholder="Nhập họ" required>
                            </div>
                            <div class="col-12">
                                <label for="phone" class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="phone" name="phone" th:value="${userObject != null ? userObject.phone : ''}" placeholder="Nhập số điện thoại">
                            </div>
                            <div class="col-12">
                                <label for="street" class="form-label">Địa chỉ chi tiết</label>
                                <input type="text" class="form-control" id="street" name="street" th:value="${userObject != null and !userObject.addresses.isEmpty() ? userObject.addresses[0].street : ''}" placeholder="Số nhà, tên đường, phường/xã, quận/huyện" required>
                            </div>
                            <div class="col-6">
                                <label for="city" class="form-label">Thành phố</label>
                                <select class="form-control" id="city" name="city" required>
                                    <option value="">Chọn thành phố</option>
                                    <option value="Thành phố Hồ Chí Minh" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].city == 'Thành phố Hồ Chí Minh'}">Thành phố Hồ Chí Minh</option>
                                    <option value="Hà Nội" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].city == 'Hà Nội'}">Hà Nội</option>
                                    <option value="Đà Nẵng" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].city == 'Đà Nẵng'}">Đà Nẵng</option>
                                    <option value="Cần Thơ" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].city == 'Cần Thơ'}">Cần Thơ</option>
                                    <option value="Hải Phòng" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].city == 'Hải Phòng'}">Hải Phòng</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="province" class="form-label">Tỉnh/Thành phố</label>
                                <select class="form-control" id="province" name="province" required>
                                    <option value="">Chọn tỉnh/thành phố</option>
                                    <option value="TP. Hồ Chí Minh" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].province == 'TP. Hồ Chí Minh'}">TP. Hồ Chí Minh</option>
                                    <option value="Hà Nội" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].province == 'Hà Nội'}">Hà Nội</option>
                                    <option value="Đà Nẵng" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].province == 'Đà Nẵng'}">Đà Nẵng</option>
                                    <option value="Cần Thơ" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].province == 'Cần Thơ'}">Cần Thơ</option>
                                    <option value="Hải Phòng" th:selected="${userObject != null and !userObject.addresses.isEmpty() and userObject.addresses[0].province == 'Hải Phòng'}">Hải Phòng</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary" form="editProfileForm">
                        <i class="bi bi-check2"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Profile Update -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const editProfileForm = document.getElementById('editProfileForm');
            const editProfileModal = document.getElementById('editProfileModal');
            
            if (editProfileForm) {
                editProfileForm.addEventListener('submit', function(e) {
                    // Validate form
                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const street = document.getElementById('street').value.trim();
                    const city = document.getElementById('city').value.trim();
                    const province = document.getElementById('province').value.trim();
                    
                    if (!firstName || !lastName) {
                        e.preventDefault();
                        alert('Vui lòng nhập đầy đủ họ và tên');
                        return false;
                    }
                    
                    if (!street || !city || !province) {
                        e.preventDefault();
                        alert('Vui lòng nhập đầy đủ thông tin địa chỉ');
                        return false;
                    }
                    
                    // Show loading state
                    const submitBtn = editProfileForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang lưu...';
                    submitBtn.disabled = true;
                    
                    // Form will submit normally to the server
                });
            }
            
            // Auto-hide alerts after 5 seconds
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                setTimeout(function() {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });
    </script>

</th:block>
</body>
</html>

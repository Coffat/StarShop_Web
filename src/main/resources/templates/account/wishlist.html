<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách yêu thích - StarShop</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .favorite-btn.active { color: red; }
        .product-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .product-image { width: 100%; height: 200px; object-fit: cover; border-radius: 5px; }
        .product-price { font-size: 1.2em; font-weight: bold; color: #e74c3c; }
        .btn-favorite { border: none; background: none; font-size: 1.5em; }
        .btn-favorite.active { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-heart text-danger"></i> Danh sách yêu thích</h1>
        <p class="text-muted">Những sản phẩm hoa mà bạn đã lưu lại</p>
        
        <!-- User Info -->
        <div class="mb-4">
            <p><strong>Người dùng:</strong> <span th:text="${userObject != null ? userObject.fullName : 'N/A'}">N/A</span></p>
            <p><strong>Tổng số yêu thích:</strong> <span th:text="${wishlistCount ?: 0}">0</span></p>
        </div>

        <!-- Empty State -->
        <div th:if="${wishlistCount == 0}" class="text-center py-5">
            <i class="fas fa-heart-broken text-muted" style="font-size: 4rem;"></i>
            <h3 class="mt-3 text-muted">Chưa có sản phẩm yêu thích</h3>
            <p class="text-muted">Hãy khám phá các sản phẩm và thêm vào danh sách yêu thích!</p>
            <a href="/products" class="btn btn-primary">
                <i class="fas fa-shopping-bag me-2"></i>
                Khám phá sản phẩm
            </a>
        </div>

        <!-- Favorites Grid -->
        <div th:if="${wishlistCount > 0}" id="favoritesContainer">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Danh sách sản phẩm yêu thích</h3>
                <button class="btn btn-outline-danger" onclick="clearAllFavorites()">
                    <i class="fas fa-trash me-1"></i>
                    Xóa tất cả
                </button>
            </div>
            
            <div class="row" id="favoritesList">
                <!-- Favorites will be loaded here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Load favorites on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFavorites();
        });

        // Load favorites from API
        function loadFavorites() {
            fetch('/favorites/api/list')
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.length > 0) {
                    displayFavorites(data.data);
                }
            })
            .catch(error => console.error('Error loading favorites:', error));
        }

        // Display favorites in grid
        function displayFavorites(favorites) {
            const container = document.getElementById('favoritesList');
            let html = '';
            
            favorites.forEach(fav => {
                html += `
                    <div class="col-md-4 mb-4" data-product-id="${fav.productId}">
                        <div class="product-card">
                            <img src="${fav.productImage || '/images/placeholder-product.jpg'}" 
                                 alt="${fav.productName}" class="product-image">
                            
                            <div class="mt-3">
                                <h5 class="mb-2">${fav.productName}</h5>
                                
                                <div class="product-price mb-2">
                                    ${fav.productPrice ? fav.productPrice.toLocaleString() + '₫' : 'Liên hệ'}
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-heart text-danger me-1"></i>
                                        Yêu thích từ ${new Date(fav.followedAt).toLocaleDateString('vi-VN')}
                                    </small>
                                </div>
                                
                                <div class="mb-2">
                                    <small class="text-muted">
                                        Trạng thái: 
                                        <span class="${fav.productStatus === 'ACTIVE' ? 'text-success' : 'text-danger'}">
                                            ${fav.productStatus === 'ACTIVE' ? 'Còn hàng' : 'Hết hàng'}
                                        </span>
                                    </small>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-danger btn-sm" onclick="removeFavorite(${fav.productId})">
                                        <i class="fas fa-heart-broken me-1"></i>
                                        Xóa yêu thích
                                    </button>
                                    
                                    <a href="/products/${fav.productId}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>
                                        Xem chi tiết
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Remove specific favorite
        function removeFavorite(productId) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi danh sách yêu thích?')) {
                return;
            }
            
            fetch('/favorites/api/remove', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId: parseInt(productId) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.success) {
                    // Remove the product card from UI
                    const productCard = document.querySelector(`[data-product-id="${productId}"]`);
                    if (productCard) {
                        productCard.remove();
                    }
                    
                    // Check if no favorites left
                    const remainingCards = document.querySelectorAll('#favoritesList [data-product-id]');
                    if (remainingCards.length === 0) {
                        location.reload(); // Reload to show empty state
                    }
                    
                    alert('Đã xóa sản phẩm khỏi danh sách yêu thích!');
                } else {
                    alert('Có lỗi xảy ra khi xóa sản phẩm!');
                }
            })
            .catch(error => {
                console.error('Error removing favorite:', error);
                alert('Có lỗi xảy ra khi xóa sản phẩm!');
            });
        }

        // Clear all favorites
        function clearAllFavorites() {
            if (!confirm('Bạn có chắc muốn xóa tất cả sản phẩm yêu thích?')) {
                return;
            }
            
            fetch('/favorites/api/clear', { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.success) {
                    location.reload(); // Reload to show empty state
                } else {
                    alert('Có lỗi xảy ra khi xóa danh sách yêu thích!');
                }
            })
            .catch(error => {
                console.error('Error clearing favorites:', error);
                alert('Có lỗi xảy ra khi xóa danh sách yêu thích!');
            });
        }
    </script>
</body>
</html>

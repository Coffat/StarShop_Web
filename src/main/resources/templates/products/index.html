<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layouts/main :: layout(${pageTitle}, 
          ${pageDescription}, 
          ~{::link},
          ~{::content})}">

<head>
    <link rel="stylesheet" href="/css/products.css">
</head>

<body>
<th:block th:fragment="content">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/" class="breadcrumb-link">
                        <svg class="w-4 h-4 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" />
                        </svg>
                        Trang chủ
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <span th:text="${searchQuery != null ? 'Tìm kiếm: ' + searchQuery : 'Sản phẩm'}">Sản phẩm</span>
                </li>
            </ol>
        </div>
    </nav>

    <!-- Products Header -->
    <section class="products-header">
        <div class="container">
            <div class="header-content">
                <div class="header-text" data-aos="fade-up" data-aos-duration="800">
                    <h1 class="page-title">
                        <span th:if="${searchQuery != null}">
                            Kết quả tìm kiếm: <span class="search-term" th:text="${searchQuery}">keyword</span>
                        </span>
                        <span th:unless="${searchQuery != null}">Tất cả sản phẩm</span>
                    </h1>
                    <p class="page-subtitle">
                        <span th:if="${searchQuery != null}">
                            Tìm thấy <strong th:text="${totalElements}">0</strong> sản phẩm phù hợp
                        </span>
                        <span th:unless="${searchQuery != null}">
                            Khám phá <strong th:text="${totalElements}">0</strong> sản phẩm hoa tươi đẹp tại StarShop
                        </span>
                    </p>
                </div>
                
                <!-- Search & Filter Bar -->
                <div class="header-actions" data-aos="fade-up" data-aos-duration="800" data-aos-delay="200">
                    <div class="search-section">
                        <form class="search-form" action="/products" method="GET">
                            <div class="search-input-group">
                                <svg class="search-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
                                </svg>
                                <input type="text" 
                                       class="form-control search-input" 
                                       name="search" 
                                       placeholder="Tìm hoa theo tên, mô tả..."
                                       th:value="${searchQuery}"
                                       autocomplete="off">
                                <button type="submit" class="btn-search">
                                    Tìm kiếm
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Products Toolbar -->
    <section class="products-toolbar">
        <div class="container">
            <div class="toolbar-content">
                <!-- Results Info -->
                <div class="results-info" data-aos="fade-up" data-aos-duration="600">
                    <span class="results-text">
                        Hiển thị 
                        <strong th:text="${(currentPage * pageSize) + 1}">1</strong>-<strong th:text="${#lists.size(products) + (currentPage * pageSize)}">12</strong> 
                        trong tổng số <strong th:text="${totalElements}">0</strong> sản phẩm
                    </span>
                </div>

                <!-- Sort & View Options -->
                <div class="toolbar-actions" data-aos="fade-up" data-aos-duration="600" data-aos-delay="200">
                    <!-- Sort Dropdown -->
                    <div class="sort-section">
                        <label for="sortSelect" class="sort-label">Sắp xếp:</label>
                        <select class="form-select sort-select" id="sortSelect" onchange="changeSorting(this.value)">
                            <option value="newest" th:selected="${sortBy == 'newest'}">Mới nhất</option>
                            <option value="oldest" th:selected="${sortBy == 'oldest'}">Cũ nhất</option>
                            <option value="name" th:selected="${sortBy == 'name'}">Tên A-Z</option>
                            <option value="price-asc" th:selected="${sortBy == 'price' && sortDirection == 'asc'}">Giá thấp đến cao</option>
                            <option value="price-desc" th:selected="${sortBy == 'price' && sortDirection == 'desc'}">Giá cao đến thấp</option>
                        </select>
                    </div>

                    <!-- View Toggle -->
                    <div class="view-toggle">
                        <button class="btn-view-toggle active" data-view="grid" title="Xem dạng lưới">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" />
                            </svg>
                        </button>
                        <button class="btn-view-toggle" data-view="list" title="Xem dạng danh sách">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M2 4.75A.75.75 0 0 1 2.75 4h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75ZM2 10a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 10Zm0 5.25a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Products Grid -->
    <section class="products-section">
        <div class="container">
            <!-- No Results Message -->
            <div th:if="${#lists.isEmpty(products)}" class="no-results">
                <div class="no-results-content">
                    <svg class="no-results-icon w-24 h-24 mx-auto text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
                    </svg>
                    <h3 class="no-results-title">Không tìm thấy sản phẩm nào</h3>
                    <p class="no-results-text">
                        <span th:if="${searchQuery != null}">
                            Không có sản phẩm nào phù hợp với từ khóa "<strong th:text="${searchQuery}">keyword</strong>". 
                            Hãy thử tìm kiếm với từ khóa khác.
                        </span>
                        <span th:unless="${searchQuery != null}">
                            Hiện tại chưa có sản phẩm nào. Vui lòng quay lại sau.
                        </span>
                    </p>
                    <a href="/products" class="btn-primary" th:if="${searchQuery != null}">
                        <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" />
                        </svg>
                        Xem tất cả sản phẩm
                    </a>
                </div>
            </div>

            <!-- Products Grid -->
            <div th:unless="${#lists.isEmpty(products)}" class="products-grid" id="productsGrid">
                <div th:each="product, iterStat : ${products}" 
                     class="product-card" 
                     th:data-product-id="${product.id}"
                     data-aos="fade-up" 
                     data-aos-duration="600" 
                     th:data-aos-delay="${iterStat.index * 100}">
                    <div class="product-image-container">
                        <a th:href="@{/products/{id}(id=${product.id})}" class="product-image-link">
                            <img th:src="${product.image != null ? product.image : '/images/products/default-flower.jpg'}" 
                                 th:alt="${product.name}" 
                                 th:title="${product.name}"
                                 class="product-image"
                                 loading="lazy">
                        </a>
                        
                        <!-- Product Actions -->
                        <div class="product-actions">
                            <button class="btn-action btn-wishlist" 
                                    th:data-product-id="${product.id}"
                                    title="Thêm vào yêu thích"
                                    sec:authorize="isAuthenticated()">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="m9.653 16.915-.005-.003-.019-.01a20.759 20.759 0 0 1-1.162-.682 22.045 22.045 0 0 1-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 0 1 8-2.828A4.5 4.5 0 0 1 18 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 0 1-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 0 1-.69.001l-.002-.001Z" />
                                </svg>
                            </button>
                            <button class="btn-action btn-quick-view" 
                                    th:data-product-id="${product.id}"
                                    title="Xem nhanh">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 12.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" />
                                    <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 0 1 0-1.186A10.004 10.004 0 0 1 10 3c4.257 0 7.893 2.66 9.336 6.41.147.381.146.804 0 1.186A10.004 10.004 0 0 1 10 17c-4.257 0-7.893-2.66-9.336-6.41ZM14 10a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>

                        <!-- Sale Badge -->
                        <div class="product-badge sale-badge" th:if="${product.price != null}">
                            Mới
                        </div>
                    </div>

                    <div class="product-content">
                        <div class="product-header">
                            <h3 class="product-title">
                                <a th:href="@{/products/{id}(id=${product.id})}" 
                                   class="product-title-link" 
                                   th:text="${product.name}">Tên sản phẩm</a>
                            </h3>
                            
                            <!-- Product Rating -->
                            <div class="product-rating">
                                <div class="rating-stars">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z" clip-rule="evenodd" /></svg>
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z" clip-rule="evenodd" /></svg>
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z" clip-rule="evenodd" /></svg>
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z" clip-rule="evenodd" /></svg>
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z" clip-rule="evenodd" /></svg>
                                </div>
                                <span class="rating-text">(0 đánh giá)</span>
                            </div>
                        </div>

                        <div class="product-description" th:if="${product.description != null}">
                            <p th:text="${#strings.abbreviate(product.description, 80)}">Mô tả sản phẩm...</p>
                        </div>

                        <div class="product-footer">
                            <div class="product-price">
                                <span class="current-price" th:text="${#numbers.formatCurrency(product.price)}">0₫</span>
                            </div>
                            
                            <button class="btn-add-to-cart" 
                                    th:data-product-id="${product.id}"
                                    sec:authorize="isAuthenticated()">
                                <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 5v1H4.667a1.75 1.75 0 0 0-1.743 1.598l-.826 9.5A1.75 1.75 0 0 0 3.84 19h12.32a1.75 1.75 0 0 0 1.742-1.902l-.826-9.5A1.75 1.75 0 0 0 15.333 6H14V5a4 4 0 0 0-8 0Zm4-2.5A2.5 2.5 0 0 0 7.5 5v1h5V5A2.5 2.5 0 0 0 10 2.5Z" clip-rule="evenodd" />
                                </svg>
                                Thêm vào giỏ
                            </button>
                            
                            <a th:href="@{/login}" 
                               class="btn-add-to-cart btn-login-required"
                               sec:authorize="!isAuthenticated()">
                                <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 0 1 5.25 2h5.5A2.25 2.25 0 0 1 13 4.25v2a.75.75 0 0 1-1.5 0v-2a.75.75 0 0 0-.75-.75h-5.5a.75.75 0 0 0-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 0 0 .75-.75v-2a.75.75 0 0 1 1.5 0v2A2.25 2.25 0 0 1 10.75 18h-5.5A2.25 2.25 0 0 1 3 15.75V4.25Z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M19 10a.75.75 0 0 0-.75-.75H8.704l1.048-.943a.75.75 0 1 0-1.004-1.114l-2.5 2.25a.75.75 0 0 0 0 1.114l2.5 2.25a.75.75 0 1 0 1.004-1.114L8.704 10.75H18.25A.75.75 0 0 0 19 10Z" clip-rule="evenodd" />
                                </svg>
                                Đăng nhập để mua
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pagination -->
    <nav th:if="${totalPages > 1}" class="pagination-nav" aria-label="Phân trang sản phẩm" data-aos="fade-up" data-aos-duration="600">
        <div class="container">
            <div class="pagination-wrapper">
                <ul class="pagination">
                    <!-- Previous Page -->
                    <li class="page-item" th:classappend="${isFirst} ? 'disabled'">
                        <a class="page-link" 
                           th:href="${isFirst} ? '#' : @{/products(page=${currentPage - 1}, size=${pageSize}, search=${searchQuery}, sort=${sortBy}, direction=${sortDirection})}"
                           aria-label="Trang trước">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </li>

                    <!-- Page Numbers -->
                    <li th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}" 
                        th:if="${pageNum >= (currentPage - 2) && pageNum <= (currentPage + 2)}"
                        class="page-item" 
                        th:classappend="${pageNum == currentPage} ? 'active'">
                        <a class="page-link" 
                           th:href="@{/products(page=${pageNum}, size=${pageSize}, search=${searchQuery}, sort=${sortBy}, direction=${sortDirection})}"
                           th:text="${pageNum + 1}">1</a>
                    </li>

                    <!-- Next Page -->
                    <li class="page-item" th:classappend="${isLast} ? 'disabled'">
                        <a class="page-link" 
                           th:href="${isLast} ? '#' : @{/products(page=${currentPage + 1}, size=${pageSize}, search=${searchQuery}, sort=${sortBy}, direction=${sortDirection})}"
                           aria-label="Trang sau">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </li>
                </ul>

                <!-- Pagination Info -->
                <div class="pagination-info">
                    Trang <strong th:text="${currentPage + 1}">1</strong> / <strong th:text="${totalPages}">1</strong>
                </div>
            </div>
        </div>
    </nav>

    <!-- Quick View Modal -->
    <div class="modal fade" id="quickViewModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quickViewModalLabel">Xem nhanh sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body" id="quickViewContent">
                    <!-- Quick view content will be loaded here via AJAX -->
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<script>
// Sort functionality
function changeSorting(value) {
    const url = new URL(window.location);
    
    switch(value) {
        case 'newest':
            url.searchParams.set('sort', 'newest');
            url.searchParams.delete('direction');
            break;
        case 'oldest':
            url.searchParams.set('sort', 'oldest');
            url.searchParams.delete('direction');
            break;
        case 'name':
            url.searchParams.set('sort', 'name');
            url.searchParams.set('direction', 'asc');
            break;
        case 'price-asc':
            url.searchParams.set('sort', 'price');
            url.searchParams.set('direction', 'asc');
            break;
        case 'price-desc':
            url.searchParams.set('sort', 'price');
            url.searchParams.set('direction', 'desc');
            break;
    }
    
    url.searchParams.set('page', '0'); // Reset to first page
    window.location.href = url.toString();
}

// View toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const viewToggleButtons = document.querySelectorAll('.btn-view-toggle');
    const productsGrid = document.getElementById('productsGrid');
    
    viewToggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const view = this.dataset.view;
            
            // Update active state
            viewToggleButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Update grid class
            if (view === 'list') {
                productsGrid.classList.add('products-list-view');
            } else {
                productsGrid.classList.remove('products-list-view');
            }
            
            // Save preference
            localStorage.setItem('productsView', view);
        });
    });
    
    // Load saved view preference
    const savedView = localStorage.getItem('productsView');
    if (savedView === 'list') {
        document.querySelector('[data-view="list"]').click();
    }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layouts/main :: layout(${pageTitle}, 
          ${pageDescription}, 
          ~{::link},
          ~{::content})}">

<head>
    <link rel="stylesheet" href="/css/products.css">
</head>

<body>
<th:block th:fragment="content">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/home" class="breadcrumb-link">
                        <svg class="w-4 h-4 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" />
                        </svg>
                        Trang chủ
                    </a>
                </li>
                <li th:if="${categoryName != null}" class="breadcrumb-item">
                    <a href="/products" class="breadcrumb-link">Sản phẩm</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <span th:if="${searchQuery != null}" th:text="'Tìm kiếm: ' + ${searchQuery}">Tìm kiếm</span>
                    <span th:if="${categoryName != null}" th:text="${categoryName}">Danh mục</span>
                    <span th:if="${searchQuery == null and categoryName == null}">Sản phẩm</span>
                </li>
            </ol>
        </div>
    </nav>

    <!-- Products Header with Integrated Filter -->
    <section class="products-header py-8">
        <div class="container max-w-7xl mx-auto px-4">
            <!-- Page Title -->
            <div class="text-center mb-6" data-aos="fade-up">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">
                    <span th:if="${searchQuery != null}">
                        Kết quả tìm kiếm: <span class="text-primary" th:text="${searchQuery}">keyword</span>
                    </span>
                    <span th:if="${categoryName != null}" th:text="${categoryName}">Danh mục</span>
                    <span th:if="${searchQuery == null and categoryName == null}">Tất cả sản phẩm</span>
                </h1>
                <p class="text-gray-600">
                    <span th:if="${searchQuery != null}">
                        Tìm thấy <strong th:text="${totalElements}">0</strong> sản phẩm phù hợp
                    </span>
                    <span th:if="${categoryName != null}">
                        Có <strong th:text="${totalElements}">0</strong> sản phẩm trong danh mục này
                    </span>
                    <span th:if="${searchQuery == null and categoryName == null}">
                        Khám phá <strong th:text="${totalElements}">0</strong> sản phẩm hoa tươi đẹp tại StarShop
                    </span>
                </p>
            </div>

            <!-- Unified Filter Box -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 mb-8" data-aos="fade-up" data-aos-delay="300">
                <form method="GET" th:action="@{/products}" id="filterForm" class="space-y-4">
                    <!-- Hidden inputs to preserve state -->
                    <input type="hidden" name="page" value="0">

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">
                        <!-- Category Filter -->
                        <div class="lg:col-span-3">
                            <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-th-large mr-1"></i> Danh mục
                            </label>
                            <select name="categoryId" id="categoryFilter"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                                <option value="" th:selected="${categoryId == null}">Tất cả danh mục</option>
                                <option th:each="catalog : ${catalogs}" 
                                        th:value="${catalog.id}" 
                                        th:text="${catalog.value}"
                                        th:selected="${catalog.id == categoryId}">
                                    Tên danh mục
                                </option>
                            </select>
                        </div>

                        <!-- Search Input -->
                        <div class="lg:col-span-4">
                            <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-search mr-1"></i> Tìm kiếm theo tên
                            </label>
                            <div class="relative">
                                <input type="text" id="searchInput" name="search" th:value="${searchQuery}" 
                                       placeholder="Nhập tên sản phẩm..." 
                                       class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                                <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                            </div>
                        </div>
                        
                        <!-- Sort Dropdown -->
                        <div class="lg:col-span-3">
                            <label for="sortSelect" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-sort mr-1"></i> Sắp xếp
                            </label>
                            <select name="sort" id="sortSelect" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-colors">
                                <option value="newest" th:selected="${sortBy == 'newest'}">Mới nhất</option>
                                <option value="oldest" th:selected="${sortBy == 'oldest'}">Cũ nhất</option>
                                <option value="name" th:selected="${sortBy == 'name'}">Tên A-Z</option>
                                <option value="price-asc" th:selected="${sortBy == 'price' && sortDirection == 'asc'}">Giá thấp → cao</option>
                                <option value="price-desc" th:selected="${sortBy == 'price' && sortDirection == 'desc'}">Giá cao → thấp</option>
                            </select>
                        </div>

                        <!-- Action Buttons -->
                        <div class="lg:col-span-2 flex space-x-2">
                            <button type="submit" 
                                    class="flex-1 px-4 py-3 bg-pink-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-pink-700 transition-all duration-200 shadow-md hover:shadow-lg">
                                <i class="fas fa-filter"></i>
                                <span class="hidden lg:inline ml-1">Lọc</span>
                            </button>
                            <a th:href="@{/products}" 
                               class="px-4 py-3 border border-gray-300 rounded-lg text-sm font-medium bg-white hover:bg-gray-100 transition-all duration-200 inline-flex items-center justify-center min-w-[44px]"
                               title="Xóa bộ lọc">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-700 shrink-0">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </a>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Results Info -->
            <div class="text-center text-sm text-gray-600 mb-4" data-aos="fade-up">
                Hiển thị 
                <strong th:text="${(currentPage * pageSize) + 1}">1</strong>-<strong th:text="${#lists.size(products) + (currentPage * pageSize)}">12</strong> 
                trong tổng số <strong th:text="${totalElements}">0</strong> sản phẩm
            </div>
        </div>
    </section>

    <!-- Products Grid -->
    <section class="products-section">
        <div class="container">
            <!-- No Results Message -->
            <div th:if="${#lists.isEmpty(products)}" class="no-results">
                <div class="no-results-content">
                    <svg class="no-results-icon w-24 h-24 mx-auto text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
                    </svg>
                    <h3 class="no-results-title">Không tìm thấy sản phẩm nào</h3>
                    <p class="no-results-text">
                        <span th:if="${searchQuery != null}">
                            Không có sản phẩm nào phù hợp với từ khóa "<strong th:text="${searchQuery}">keyword</strong>". 
                            Hãy thử tìm kiếm với từ khóa khác.
                        </span>
                        <span th:unless="${searchQuery != null}">
                            Hiện tại chưa có sản phẩm nào. Vui lòng quay lại sau.
                        </span>
                    </p>
                    <a href="/products" class="btn-primary" th:if="${searchQuery != null}">
                        <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" />
                        </svg>
                        Xem tất cả sản phẩm
                    </a>
                </div>
            </div>

            <!-- Products Grid -->
            <div th:unless="${#lists.isEmpty(products)}" class="products-grid" id="productsGrid">
                <div th:each="product, iterStat : ${products}" 
                     class="product-card" 
                     th:data-product-id="${product.id}"
                     data-aos="fade-up"
                     data-aos-duration="600"
                     th:data-aos-delay="${(iterStat.index % 8) * 100}">
                    <div class="product-image-container">
                        <a th:href="@{/products/{id}(id=${product.id})}" class="product-image-link">
                            <img th:src="${product.image != null ? product.image : '/images/products/default-flower.jpg'}" 
                                 th:alt="${product.name}" 
                                 th:title="${product.name}"
                                 class="product-image"
                                 width="400"
                                 height="400">
                        </a>
                        
                        <!-- Wishlist Button -->
                        <div class="product-actions">
                            <button class="btn-action btn-wishlist"
                                    th:data-product-id="${product.id}"
                                    th:classappend="${#sets.contains(wishlistProductIds, product.id)} ? ' active'"
                                    title="Thêm vào yêu thích"
                                    sec:authorize="isAuthenticated()">
                                <!-- Heroicons: Solid heart when active -->
                                <svg th:if="${#sets.contains(wishlistProductIds, product.id)}" class="hero-icon hero-icon-lg" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/>
                                </svg>
                                <!-- Heroicons: Outline heart when inactive -->
                                <svg th:unless="${#sets.contains(wishlistProductIds, product.id)}" class="hero-icon hero-icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Sale Badge -->
                        <div class="product-badge sale-badge" th:if="${product.price != null}">
                            Mới
                        </div>
                    </div>

                    <div class="product-content">
                        <div class="product-header">
                            <h3 class="product-title">
                                <a th:href="@{/products/{id}(id=${product.id})}" 
                                   class="product-title-link" 
                                   th:text="${product.name}">Tên sản phẩm</a>
                            </h3>
                            
                            <!-- Product Rating -->
                            <div class="product-rating" th:if="${productsWithRatings != null}">
                                <div class="rating-stars">
                                    <th:block th:each="star : ${#numbers.sequence(1, 5)}">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                             th:classappend="${productsWithRatings[product.id] != null and star le productsWithRatings[product.id].averageRating ? 'text-yellow-400' : 'text-gray-300'}">
                                            <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z" clip-rule="evenodd" />
                                        </svg>
                                    </th:block>
                                </div>
                                <span class="rating-text">
                                    (<span th:text="${productsWithRatings[product.id] != null ? productsWithRatings[product.id].reviewCount : 0}">0</span> đánh giá)
                                </span>
                            </div>
                        </div>

                        <div class="product-description" th:if="${product.description != null}">
                            <p th:text="${#strings.abbreviate(product.description, 80)}">Mô tả sản phẩm...</p>
                        </div>

                        <div class="product-footer">
                            <div class="product-price">
                                <span class="current-price" th:text="${#numbers.formatCurrency(product.price)}">0₫</span>
                            </div>
                            
                            <button class="btn-add-to-cart" 
                                    th:data-product-id="${product.id}"
                                    sec:authorize="isAuthenticated()">
                                <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 5v1H4.667a1.75 1.75 0 0 0-1.743 1.598l-.826 9.5A1.75 1.75 0 0 0 3.84 19h12.32a1.75 1.75 0 0 0 1.742-1.902l-.826-9.5A1.75 1.75 0 0 0 15.333 6H14V5a4 4 0 0 0-8 0Zm4-2.5A2.5 2.5 0 0 0 7.5 5v1h5V5A2.5 2.5 0 0 0 10 2.5Z" clip-rule="evenodd" />
                                </svg>
                                Thêm vào giỏ
                            </button>
                            
                            <a th:href="@{/login}" 
                               class="btn-add-to-cart btn-login-required"
                               sec:authorize="!isAuthenticated()">
                                <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 0 1 5.25 2h5.5A2.25 2.25 0 0 1 13 4.25v2a.75.75 0 0 1-1.5 0v-2a.75.75 0 0 0-.75-.75h-5.5a.75.75 0 0 0-.75.75v11.5c0 .414.336.75.75.75h5.5a.75.75 0 0 0 .75-.75v-2a.75.75 0 0 1 1.5 0v2A2.25 2.25 0 0 1 10.75 18h-5.5A2.25 2.25 0 0 1 3 15.75V4.25Z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M19 10a.75.75 0 0 0-.75-.75H8.704l1.048-.943a.75.75 0 1 0-1.004-1.114l-2.5 2.25a.75.75 0 0 0 0 1.114l2.5 2.25a.75.75 0 1 0 1.004-1.114L8.704 10.75H18.25A.75.75 0 0 0 19 10Z" clip-rule="evenodd" />
                                </svg>
                                Đăng nhập để mua
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pagination -->
    <!-- ✅ Chỉ hiện khi: isPaginationEnabled=true VÀ có nhiều hơn 1 trang -->
    <nav th:if="${isPaginationEnabled != null && isPaginationEnabled && totalPages > 1}" 
         class="pagination-nav" 
         aria-label="Phân trang sản phẩm" 
         data-aos="fade-up" 
         data-aos-duration="600">
        <div class="container">
            <div class="pagination-wrapper">
                <ul class="pagination">
                    <!-- Previous Page -->
                    <li class="page-item" th:classappend="${isFirst} ? 'disabled'">
                        <a class="page-link" 
                           th:href="${isFirst} ? '#' : @{/products(page=${currentPage - 1}, size=${pageSize}, search=${searchQuery}, categoryId=${categoryId}, sort=${sortBy}, direction=${sortDirection})}"
                           aria-label="Trang trước">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </li>

                    <!-- Page Numbers -->
                    <li th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}" 
                        th:if="${pageNum >= (currentPage - 2) && pageNum <= (currentPage + 2)}"
                        class="page-item" 
                        th:classappend="${pageNum == currentPage} ? 'active'">
                        <a class="page-link" 
                           th:href="@{/products(page=${pageNum}, size=${pageSize}, search=${searchQuery}, categoryId=${categoryId}, sort=${sortBy}, direction=${sortDirection})}"
                           th:text="${pageNum + 1}">1</a>
                    </li>

                    <!-- Next Page -->
                    <li class="page-item" th:classappend="${isLast} ? 'disabled'">
                        <a class="page-link" 
                           th:href="${isLast} ? '#' : @{/products(page=${currentPage + 1}, size=${pageSize}, search=${searchQuery}, categoryId=${categoryId}, sort=${sortBy}, direction=${sortDirection})}"
                           aria-label="Trang sau">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </li>
                </ul>

                <!-- Pagination Info -->
                <div class="pagination-info">
                    Trang <strong th:text="${currentPage + 1}">1</strong> / <strong th:text="${totalPages}">1</strong>
                </div>
            </div>
        </div>
    </nav>
</th:block>

<!-- All JavaScript logic is handled in /js/products.js -->
<!-- No inline scripts needed - AJAX filtering, view toggle, etc. are in products.js -->

</body>
</html>

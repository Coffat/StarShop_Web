<!-- Staff Chat Interface Content -->
<div class="h-full flex flex-col lg:flex-row gap-4" x-data="staffChat()" x-init="init()">
    
    <!-- Left Sidebar - Conversations List -->
    <div class="lg:w-80 flex flex-col bg-white rounded-lg shadow overflow-hidden">
        <!-- Search -->
        <div class="p-4 border-b border-gray-200">
            <div class="relative">
                <input type="text" 
                       x-model="searchQuery"
                       @input="searchConversations()"
                       placeholder="Tìm kiếm khách hàng..."
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
        
        <!-- Conversations List -->
        <div class="flex-1 overflow-y-auto chat-scrollbar">
            <template x-if="loading">
                <div class="flex items-center justify-center p-8">
                    <div class="spinner"></div>
                </div>
            </template>
            
            <template x-if="!loading && conversations.length === 0">
                <div class="text-center py-12 px-4">
                    <i class="fas fa-comments text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">Chưa có cuộc hội thoại nào</p>
                </div>
            </template>
            
            <template x-for="conv in conversations" :key="conv.id.toString()">
                <div @click="selectConversation(conv)"
                     :class="{'bg-primary-50 border-l-4 border-primary-500': selectedConversation && selectedConversation.id === conv.id}"
                     class="conversation-item p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors">
                    <div class="flex items-start space-x-3">
                        <!-- Avatar -->
                        <div class="flex-shrink-0 relative">
                            <template x-if="conv.customerAvatar">
                                <img :src="conv.customerAvatar" :alt="conv.customerName" 
                                     class="w-12 h-12 rounded-full object-cover">
                            </template>
                            <template x-if="!conv.customerAvatar">
                                <div class="w-12 h-12 rounded-full bg-primary-500 flex items-center justify-center">
                                    <span class="text-white font-semibold text-lg" x-text="conv.customerName.charAt(0)"></span>
                                </div>
                            </template>
                            <template x-if="conv.unreadCount > 0">
                                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center"
                                      x-text="conv.unreadCount"></span>
                            </template>
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <h4 class="font-semibold text-gray-900 truncate" x-text="conv.customerName"></h4>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs text-gray-500" x-text="formatTime(conv.lastMessageAt)"></span>
                                    <template x-if="conv.status === 'OPEN'">
                                        <button @click.stop="assignConversation(conv.id)" 
                                                class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors">
                                            <i class="fas fa-hand-paper mr-1"></i>Nhận
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 truncate" x-text="conv.lastMessageContent || 'Chưa có tin nhắn'"></p>
                            <div class="flex items-center space-x-2 mt-1">
                                <template x-if="conv.status === 'OPEN'">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-clock mr-1"></i> Chưa xử lý
                                    </span>
                                </template>
                                <template x-if="conv.status === 'ASSIGNED'">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                        <i class="fas fa-user mr-1"></i> Đã nhận
                                    </span>
                                </template>
                                <template x-if="conv.priority === 'HIGH'">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">
                                        <i class="fas fa-exclamation-circle mr-1"></i> Cao
                                    </span>
                                </template>
                                <template x-if="conv.priority === 'URGENT'">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-exclamation-triangle mr-1"></i> Khẩn cấp
                                    </span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col bg-white rounded-lg shadow overflow-hidden">
        <template x-if="!selectedConversation">
            <div class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-comments text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">Chọn cuộc hội thoại để bắt đầu</p>
                </div>
            </div>
        </template>
        
        <template x-if="selectedConversation">
            <div class="flex-1 flex flex-col h-full">
                <!-- Chat Header -->
                <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-primary-50 to-pink-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <template x-if="selectedConversation.customerAvatar">
                                <img :src="selectedConversation.customerAvatar" 
                                     :alt="selectedConversation.customerName" 
                                     class="w-10 h-10 rounded-full object-cover">
                            </template>
                            <template x-if="!selectedConversation.customerAvatar">
                                <div class="w-10 h-10 rounded-full bg-primary-500 flex items-center justify-center">
                                    <span class="text-white font-semibold" x-text="selectedConversation.customerName.charAt(0)"></span>
                                </div>
                            </template>
                            <div>
                                <h3 class="font-semibold text-gray-900" x-text="selectedConversation.customerName"></h3>
                                <p class="text-sm text-gray-600" x-text="selectedConversation.customerEmail"></p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <template x-if="selectedConversation.status !== 'CLOSED'">
                                <button @click="closeConversation()" 
                                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                    <i class="fas fa-times mr-2"></i>Đóng
                                </button>
                            </template>
                            <template x-if="selectedConversation.status === 'CLOSED'">
                                <button @click="reopenConversation()" 
                                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                    <i class="fas fa-redo mr-2"></i>Mở lại
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50 chat-scrollbar" 
                     id="messagesContainer"
                     @scroll="handleScroll"
                     style="height: calc(100vh - 300px); max-height: calc(100vh - 300px); min-height: 400px;">
                    <template x-if="loadingMessages">
                        <div class="flex items-center justify-center p-8">
                            <div class="spinner"></div>
                        </div>
                    </template>
                    
                    <template x-for="msg in messages" :key="msg.id.toString()">
                        <div :class="msg.senderId === staffId ? 'flex justify-end' : 'flex justify-start'">
                            <div :class="{
                                'message-sent': msg.senderId === staffId,
                                'message-received': msg.senderId !== staffId && msg.messageType === 'TEXT',
                                'message-system': msg.messageType === 'SYSTEM',
                                'message-ai': msg.isAiGenerated
                            }" class="message-bubble">
                                <template x-if="msg.messageType !== 'SYSTEM'">
                                    <div class="flex items-start space-x-2">
                                        <div class="flex-1">
                                            <p class="text-sm" x-text="msg.content"></p>
                                            <div class="message-time mt-1" 
                                                 x-text="formatMessageTime(msg.sentAt)"></div>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="msg.messageType === 'SYSTEM'">
                                    <p class="text-sm" x-text="msg.content"></p>
                                </template>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Typing Indicator -->
                    <template x-if="isTyping">
                        <div class="flex justify-start">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Message Input -->
                <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
                    <div class="flex items-end space-x-3">
                        <div class="flex-1">
                            <textarea x-model="messageText"
                                     @keydown.enter.prevent="sendMessage()"
                                     @input="handleTyping()"
                                     placeholder="Nhập tin nhắn..."
                                     rows="2"
                                     class="message-input w-full"></textarea>
                        </div>
                        <button @click="sendMessage()"
                                :disabled="!messageText.trim() || sendingMessage"
                                class="send-button px-6 py-3 rounded-full text-white font-medium flex items-center space-x-2">
                            <template x-if="!sendingMessage">
                                <i class="fas fa-paper-plane"></i>
                            </template>
                            <template x-if="sendingMessage">
                                <i class="fas fa-spinner fa-spin"></i>
                            </template>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Right Sidebar - Customer Info (Hidden on mobile) -->
    <div class="hidden xl:block w-80 bg-white rounded-lg shadow p-6" x-show="selectedConversation">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-info-circle mr-2 text-primary-600"></i>
            Thông tin khách hàng
        </h3>
        
        <template x-if="selectedConversation">
            <div class="space-y-4">
                <!-- Customer Details -->
                <div class="border-b border-gray-200 pb-4">
                    <div class="text-center mb-4">
                        <template x-if="selectedConversation.customerAvatar">
                            <img :src="selectedConversation.customerAvatar" 
                                 :alt="selectedConversation.customerName" 
                                 class="w-20 h-20 rounded-full object-cover mx-auto mb-3">
                        </template>
                        <template x-if="!selectedConversation.customerAvatar">
                            <div class="w-20 h-20 rounded-full bg-primary-500 flex items-center justify-center mx-auto mb-3">
                                <span class="text-white font-bold text-2xl" x-text="selectedConversation.customerName.charAt(0)"></span>
                            </div>
                        </template>
                        <h4 class="font-semibold text-gray-900" x-text="selectedConversation.customerName"></h4>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-envelope w-6"></i>
                            <span x-text="selectedConversation.customerEmail"></span>
                        </div>
                        <template x-if="selectedConversation.customerPhone">
                            <div class="flex items-center text-gray-600">
                                <i class="fas fa-phone w-6"></i>
                                <span x-text="selectedConversation.customerPhone"></span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- Conversation Info -->
                <div class="border-b border-gray-200 pb-4">
                    <h5 class="font-semibold text-gray-900 mb-3">Thông tin cuộc hội thoại</h5>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Trạng thái:</span>
                            <span class="font-medium" x-text="getStatusText(selectedConversation.status)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Độ ưu tiên:</span>
                            <span class="font-medium" x-text="getPriorityText(selectedConversation.priority)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Bắt đầu:</span>
                            <span x-text="formatDateTime(selectedConversation.createdAt)"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div>
                    <h5 class="font-semibold text-gray-900 mb-3">Thao tác nhanh</h5>
                    <div class="space-y-2">
                        <button class="w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm">
                            <i class="fas fa-user mr-2"></i>Xem hồ sơ khách hàng
                        </button>
                        <button class="w-full px-4 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors text-sm">
                            <i class="fas fa-shopping-cart mr-2"></i>Xem đơn hàng
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script th:inline="javascript">
function staffChat() {
    return {
        staffId: /*[[${staffId}]]*/ null,
        conversations: [],
        selectedConversation: null,
        messages: [],
        messageText: '',
        searchQuery: '',
        loading: false,
        loadingMessages: false,
        sendingMessage: false,
        isTyping: false,
        typingTimeout: null,
        stompClient: null,
        
        async init() {
            await this.loadConversations();
            this.connectWebSocket();
            
            // Check if conversation ID in URL
            const urlParams = new URLSearchParams(window.location.search);
            const convId = urlParams.get('conversation');
            if (convId) {
                const conv = this.conversations.find(c => c.id == convId);
                if (conv) {
                    this.selectConversation(conv);
                }
            }
            
            // Setup real-time updates like Messenger/Zalo
            this.setupRealTimeUpdates();
        },
        
        async loadConversations() {
            this.loading = true;
            try {
                const csrf = this.getCsrfToken();
                const headers = {};
                if (csrf.token) {
                    headers[csrf.header] = csrf.token;
                }
                
                const response = await fetch('/api/staff/conversations?page=0&size=50', {
                    headers: headers
                });
                const data = await response.json();
                if (data.data && !data.error) {
                    this.conversations = data.data || [];
                    console.log('Loaded conversations:', this.conversations);
                } else {
                    console.error('Error loading conversations:', data.error);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async selectConversation(conv) {
            this.selectedConversation = conv;
            await this.loadMessages(conv.id);
            
            // Mark as read when staff opens the conversation
            this.markAsRead(conv.id);
            
            // Subscribe to this conversation
            if (this.stompClient && this.stompClient.connected) {
                try {
                    this.stompClient.subscribe('/topic/chat/' + conv.id, (message) => {
                        const msg = JSON.parse(message.body);
                        this.handleIncomingMessage(msg);
                    });
                } catch (error) {
                    console.error('Error subscribing to conversation:', error);
                }
            }
            
            // Scroll to bottom
            this.$nextTick(() => {
                this.scrollToBottom();
            });
        },
        
        async loadMessages(conversationId) {
            this.loadingMessages = true;
            try {
                const csrf = this.getCsrfToken();
                const headers = {};
                if (csrf.token) {
                    headers[csrf.header] = csrf.token;
                }
                
                const response = await fetch(`/api/chat/conversations/${conversationId}/messages?page=0&size=100`, {
                    headers: headers
                });
                const data = await response.json();
                if (data.data && !data.error) {
                    this.messages = (data.data || []).reverse();
                } else {
                    console.error('Error loading messages:', data.error);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            } finally {
                this.loadingMessages = false;
            }
        },
        
        async sendMessage() {
            if (!this.messageText.trim() || !this.selectedConversation || this.sendingMessage) return;
            
            this.sendingMessage = true;
            try {
                const messageDTO = {
                    conversationId: this.selectedConversation.id.toString(),
                    senderId: this.staffId,
                    receiverId: this.selectedConversation.customerId,
                    content: this.messageText.trim(),
                    messageType: 'TEXT'
                };
                
                // Send via WebSocket if connected
                if (this.stompClient && this.stompClient.connected) {
                    try {
                        this.stompClient.send('/app/chat.send', {}, JSON.stringify(messageDTO));
                    } catch (error) {
                        console.error('Error sending via WebSocket:', error);
                        // Fallback to REST API
                        await this.sendMessageViaRest(messageDTO);
                    }
                } else {
                    // Fallback to REST API
                    await this.sendMessageViaRest(messageDTO);
                }
                
                this.messageText = '';
                this.$nextTick(() => this.scrollToBottom());
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Không thể gửi tin nhắn');
            } finally {
                this.sendingMessage = false;
            }
        },
        
        handleIncomingMessage(msg) {
            if (this.selectedConversation && msg.conversationId == this.selectedConversation.id) {
                this.messages.push(msg);
                this.$nextTick(() => this.scrollToBottom());
                
                // Mark as read if message is from customer (not from staff)
                if (msg.senderId !== this.staffId) {
                    this.markAsRead(this.selectedConversation.id);
                }
            }
            
            // Update conversation in list without reloading entire list
            this.updateConversationInList(msg.conversationId, msg);
        },
        
        async markAsRead(conversationId) {
            try {
                const csrf = this.getCsrfToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (csrf.token) {
                    headers[csrf.header] = csrf.token;
                }
                
                await fetch(`/api/chat/conversations/${conversationId}/read`, {
                    method: 'PUT',
                    headers: headers
                });
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        },
        
        getCsrfToken() {
            const token = document.querySelector('meta[name="_csrf"]');
            const header = document.querySelector('meta[name="_csrf_header"]');
            return {
                token: token ? token.getAttribute('content') : null,
                header: header ? header.getAttribute('content') : null
            };
        },
        
        async sendMessageViaRest(messageDTO) {
            const csrf = this.getCsrfToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (csrf.token) {
                headers[csrf.header] = csrf.token;
            }
            
            const response = await fetch('/api/chat/messages', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(messageDTO)
            });
            const data = await response.json();
            if (data.data && !data.error) {
                this.messages.push(data.data);
            } else {
                console.error('Error sending message:', data.error);
            }
        },
        
        async closeConversation() {
            if (!confirm('Bạn có chắc muốn đóng cuộc hội thoại này?')) return;
            
            try {
                const csrf = this.getCsrfToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (csrf.token) {
                    headers[csrf.header] = csrf.token;
                }
                
                const response = await fetch(`/api/staff/conversations/${this.selectedConversation.id}/close`, {
                    method: 'POST',
                    headers: headers
                });
                const data = await response.json();
                if (data.data && !data.error) {
                    this.selectedConversation.status = 'CLOSED';
                    // Update conversation in list without reload
                    this.updateConversationStatus(this.selectedConversation.id, 'CLOSED');
                    alert('Đã đóng cuộc hội thoại');
                } else {
                    console.error('Error closing conversation:', data.error);
                    alert('Không thể đóng cuộc hội thoại: ' + data.error);
                }
            } catch (error) {
                console.error('Error closing conversation:', error);
            }
        },
        
        async reopenConversation() {
            try {
                const csrf = this.getCsrfToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (csrf.token) {
                    headers[csrf.header] = csrf.token;
                }
                
                const response = await fetch(`/api/staff/conversations/${this.selectedConversation.id}/reopen`, {
                    method: 'POST',
                    headers: headers
                });
                const data = await response.json();
                if (data.data && !data.error) {
                    this.selectedConversation.status = 'ASSIGNED';
                    // Update conversation in list without reload
                    this.updateConversationStatus(this.selectedConversation.id, 'ASSIGNED');
                } else {
                    console.error('Error reopening conversation:', data.error);
                }
            } catch (error) {
                console.error('Error reopening conversation:', error);
            }
        },
        
        async searchConversations() {
            if (!this.searchQuery.trim()) {
                // Don't reload if we already have conversations loaded
                if (this.conversations.length === 0) {
                    await this.loadConversations();
                }
                return;
            }
            
            try {
                const csrf = this.getCsrfToken();
                const headers = {};
                if (csrf.token) {
                    headers[csrf.header] = csrf.token;
                }
                
                const response = await fetch(`/api/staff/conversations/search?q=${encodeURIComponent(this.searchQuery)}`, {
                    headers: headers
                });
                const data = await response.json();
                if (data.data && !data.error) {
                    this.conversations = data.data || [];
                } else {
                    console.error('Error searching conversations:', data.error);
                }
            } catch (error) {
                console.error('Error searching conversations:', error);
            }
        },
        
        async assignConversation(conversationId) {
            try {
                const csrf = this.getCsrfToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (csrf.token) {
                    headers[csrf.header] = csrf.token;
                }
                
                const response = await fetch(`/api/staff/conversations/${conversationId}/assign`, {
                    method: 'POST',
                    headers: headers
                });
                const data = await response.json();
                if (data.data && !data.error) {
                    // Update conversation status without reload
                    this.updateConversationStatus(conversationId, 'ASSIGNED');
                    alert('Đã nhận cuộc hội thoại');
                } else {
                    console.error('Error assigning conversation:', data.error);
                    alert('Không thể nhận cuộc hội thoại: ' + data.error);
                }
            } catch (error) {
                console.error('Error assigning conversation:', error);
                alert('Không thể nhận cuộc hội thoại');
            }
        },
        
        handleTyping() {
            if (this.typingTimeout) {
                clearTimeout(this.typingTimeout);
            }
            
            if (this.stompClient && this.stompClient.connected && this.selectedConversation) {
                try {
                    this.stompClient.send('/app/chat.typing', {}, JSON.stringify({
                        conversationId: this.selectedConversation.id.toString(),
                        userId: this.staffId,
                        userName: 'Staff'
                    }));
                } catch (error) {
                    console.error('Error sending typing indicator:', error);
                }
            }
            
            this.typingTimeout = setTimeout(() => {
                // Typing stopped
            }, 1000);
        },
        
        connectWebSocket() {
            try {
                const socket = new SockJS('/ws');
                this.stompClient = Stomp.over(socket);
                this.stompClient.debug = null;
                
                this.stompClient.connect({}, (frame) => {
                    console.log('WebSocket connected for chat');
                    
                    // Subscribe to new conversation notifications
                    this.stompClient.subscribe('/topic/notifications', (message) => {
                        const notification = JSON.parse(message.body);
                        if (notification.type === 'new_conversation') {
                            // Only reload if we don't have conversations loaded yet
                            if (this.conversations.length === 0) {
                                this.loadConversations();
                            }
                            this.showNotification(notification.message);
                        }
                    });
                    
                    // Subscribe to conversation updates (like Messenger/Zalo)
                    this.stompClient.subscribe('/topic/conversation-updates', (message) => {
                        const update = JSON.parse(message.body);
                        this.handleConversationUpdate(update);
                    });
                    
                    // Subscribe to general chat updates
                    this.stompClient.subscribe('/topic/chat-updates', (message) => {
                        const update = JSON.parse(message.body);
                        this.handleChatUpdate(update);
                    });
                    
                }, (error) => {
                    console.error('WebSocket error:', error);
                    // Exponential backoff for reconnection
                    setTimeout(() => this.connectWebSocket(), 5000);
                });
            } catch (error) {
                console.error('Error creating WebSocket connection:', error);
            }
        },
        
        setupRealTimeUpdates() {
            // Setup periodic health check for WebSocket connection
            setInterval(() => {
                if (!this.stompClient || !this.stompClient.connected) {
                    console.log('WebSocket disconnected, attempting to reconnect...');
                    this.connectWebSocket();
                }
            }, 10000); // Check every 10 seconds
            
            // Setup periodic conversation list refresh (much less frequent)
            setInterval(() => {
                // Only refresh if no conversation is selected and no recent activity
                if (!this.selectedConversation) {
                    this.loadConversations();
                }
            }, 300000); // Refresh every 5 minutes only when no conversation selected
        },
        
        handleConversationUpdate(update) {
            // Update conversation in the list without full reload (like Messenger/Zalo)
            const index = this.conversations.findIndex(c => c.id === update.conversationId);
            if (index !== -1) {
                // Update specific conversation data
                this.conversations[index] = { ...this.conversations[index], ...update.data };
                
                // Move updated conversation to top (like Messenger/Zalo)
                if (update.updateType === 'new_message') {
                    const updatedConv = this.conversations.splice(index, 1)[0];
                    this.conversations.unshift(updatedConv);
                }
            } else if (update.updateType === 'new_conversation') {
                // Only reload conversations if it's truly a new conversation
                // Don't reload if it's just an update to existing conversation
                // Check if conversation already exists in our list
                const exists = this.conversations.some(c => c.id === update.conversationId);
                if (!exists) {
                    this.loadConversations();
                }
            }
        },
        
        handleChatUpdate(update) {
            // Handle general chat updates (like Messenger/Zalo)
            switch (update.type) {
                case 'message_sent':
                    // Don't reload entire conversation list, just update specific conversation
                    if (update.data && update.data.conversationId) {
                        this.updateConversationInList(update.data.conversationId, update.data);
                    }
                    break;
                case 'conversation_status_changed':
                    // Update conversation status
                    this.handleConversationUpdate(update);
                    break;
                case 'user_typing':
                    // Handle typing indicators
                    this.handleTypingIndicator(update);
                    break;
                default:
                    console.log('Unknown chat update type:', update.type);
            }
        },
        
        handleTypingIndicator(update) {
            // Show typing indicator (like Messenger/Zalo)
            if (this.selectedConversation && update.conversationId === this.selectedConversation.id) {
                this.isTyping = true;
                setTimeout(() => {
                    this.isTyping = false;
                }, 3000);
            }
        },
        
        updateConversationInList(conversationId, messageData) {
            // Update specific conversation without reloading entire list
            const index = this.conversations.findIndex(c => c.id === conversationId);
            if (index !== -1) {
                // Update last message info
                this.conversations[index].lastMessageContent = messageData.content;
                this.conversations[index].lastMessageSenderId = messageData.senderId;
                this.conversations[index].lastMessageAt = messageData.sentAt;
                
                // Update unread count if message is from customer
                if (messageData.senderId !== this.staffId) {
                    this.conversations[index].unreadCount = (this.conversations[index].unreadCount || 0) + 1;
                }
                
                // Move conversation to top if it's not already selected
                if (!this.selectedConversation || this.selectedConversation.id !== conversationId) {
                    const updatedConv = this.conversations.splice(index, 1)[0];
                    this.conversations.unshift(updatedConv);
                }
            }
        },
        
        updateConversationStatus(conversationId, newStatus) {
            // Update conversation status without reloading entire list
            const index = this.conversations.findIndex(c => c.id === conversationId);
            if (index !== -1) {
                this.conversations[index].status = newStatus;
                
                // Update selected conversation if it's the same
                if (this.selectedConversation && this.selectedConversation.id === conversationId) {
                    this.selectedConversation.status = newStatus;
                }
            }
        },
        
        showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        },
        
        scrollToBottom() {
            this.$nextTick(() => {
                const container = document.getElementById('messagesContainer');
                if (container) {
                    // Smooth scroll to bottom
                    container.scrollTo({
                        top: container.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            });
        },
        
        handleScroll(event) {
            // Load more messages if scrolled to top
            if (event.target.scrollTop === 0 && !this.loadingMessages) {
                // TODO: Load more messages
            }
        },
        
        formatTime(dateTime) {
            if (!dateTime) return '';
            const date = new Date(dateTime);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Vừa xong';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' phút';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' giờ';
            return date.toLocaleDateString('vi-VN');
        },
        
        formatMessageTime(dateTime) {
            if (!dateTime) return '';
            const date = new Date(dateTime);
            return date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
        },
        
        formatDateTime(dateTime) {
            if (!dateTime) return '';
            const date = new Date(dateTime);
            return date.toLocaleString('vi-VN');
        },
        
        getStatusText(status) {
            const map = {
                'OPEN': 'Chưa xử lý',
                'ASSIGNED': 'Đang xử lý',
                'CLOSED': 'Đã đóng'
            };
            return map[status] || status;
        },
        
        getPriorityText(priority) {
            const map = {
                'LOW': 'Thấp',
                'NORMAL': 'Bình thường',
                'HIGH': 'Cao',
                'URGENT': 'Khẩn cấp'
            };
            return map[priority] || priority;
        }
    }
}
</script>


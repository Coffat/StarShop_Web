<!-- Staff Orders List -->
<div xmlns:th="http://www.thymeleaf.org">
    <div class="space-y-6 p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">Đơn hàng</h2>
                <p class="mt-1 text-sm text-gray-500">Danh sách tất cả đơn hàng</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <form method="get" th:action="@{/staff/orders}">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" th:value="${currentStatus}">
                            <option value="">Tất cả trạng thái</option>
                            <option th:each="status : ${orderStatuses}"
                                    th:value="${status.name()}"
                                    th:text="${status.displayName}"
                                    th:selected="${status.name() == currentStatus}">
                            </option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sắp xếp</label>
                        <select name="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" th:value="${sortBy}">
                            <option value="orderDate" th:selected="${sortBy == 'orderDate'}">Ngày đặt hàng</option>
                            <option value="totalAmount" th:selected="${sortBy == 'totalAmount'}">Tổng tiền</option>
                            <option value="status" th:selected="${sortBy == 'status'}">Trạng thái</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Thứ tự</label>
                        <select name="sortDir" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" th:value="${sortDir}">
                            <option value="desc" th:selected="${sortDir == 'desc'}">Mới nhất</option>
                            <option value="asc" th:selected="${sortDir == 'asc'}">Cũ nhất</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tìm kiếm</label>
                        <input type="text" name="search" th:value="${currentSearch}" placeholder="Mã đơn hàng, tên khách hàng..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Từ ngày</label>
                        <input type="date" name="fromDate" th:value="${fromDate}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Đến ngày</label>
                        <input type="date" name="toDate" th:value="${toDate}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div class="md:col-span-2 flex items-end space-x-2">
                        <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200">
                            <i class="fas fa-search mr-1"></i>Lọc
                        </button>
                        <a th:href="@{/staff/orders}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200">Xóa lọc</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Orders Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã đơn hàng</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đặt</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:if="${orders.empty}" class="hover:bg-gray-50">
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                                <p class="text-lg font-medium">Không có đơn hàng nào</p>
                                <p class="text-sm">Thử thay đổi bộ lọc hoặc tìm kiếm khác</p>
                            </td>
                        </tr>

                        <tr th:each="order : ${orders.content}" class="hover:bg-gray-50 transition-colors duration-200">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" th:text="'#' + ${order.id}">#001234</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="h-8 w-8 bg-primary-100 rounded-full flex items-center justify-center">
                                        <span class="text-sm font-medium text-primary-600"
                                              th:text="${order.userFullName != null ? #strings.substring(order.userFullName, 0, 2).toUpperCase() : 'NA'}">NA</span>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900" th:text="${order.userFullName ?: 'N/A'}">N/A</div>
                                        <div class="text-sm text-gray-500" th:text="${order.userEmail ?: ''}"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm') : 'N/A'}">
                                15/12/2024
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                th:text="${order.totalAmount != null ? #numbers.formatCurrency(order.totalAmount) : '0₫'}">
                                1,250,000₫
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span th:class="${'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' +
                                              (order.status != null ? 
                                                (order.status.name() == 'COMPLETED' ? 'bg-green-100 text-green-800' :
                                                (order.status.name() == 'PROCESSING' ? 'bg-blue-100 text-blue-800' :
                                                (order.status.name() == 'SHIPPED' ? 'bg-purple-100 text-purple-800' :
                                                (order.status.name() == 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                                                (order.status.name() == 'CANCELLED' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800')))))
                                              : 'bg-gray-100 text-gray-800')}"
                                      th:text="${order.status != null ? order.status.displayName : 'N/A'}">
                                    Hoàn thành
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button class="text-primary-600 hover:text-primary-900 transition-colors duration-200 view-order-btn"
                                            th:data-order-id="${order.id}"
                                            title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6" th:if="${orders != null && !orders.empty}">
                <div class="flex-1 flex justify-between sm:hidden">
                    <a th:if="${currentPage > 0}"
                       th:href="@{/staff/orders(page=${currentPage - 1}, size=20, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}"
                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Trước
                    </a>
                    <a th:if="${currentPage < totalPages - 1}"
                       th:href="@{/staff/orders(page=${currentPage + 1}, size=20, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}"
                       class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Sau
                    </a>
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Hiển thị 
                            <span class="font-medium" th:text="${currentPage * 20 + 1}">1</span> 
                            đến 
                            <span class="font-medium" th:text="${#numbers.formatInteger((currentPage + 1) * 20 > totalElements ? totalElements : (currentPage + 1) * 20, 0)}">10</span> 
                            của 
                            <span class="font-medium" th:text="${totalElements}">97</span> 
                            kết quả
                        </p>
                    </div>
                    <div th:if="${totalPages > 1}">
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <a th:if="${currentPage > 0}"
                               th:href="@{/staff/orders(page=${currentPage - 1}, size=20, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}"
                               class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                            <span th:each="page : ${#numbers.sequence(0, totalPages - 1)}" th:if="${page >= currentPage - 2 && page <= currentPage + 2}">
                                <a th:if="${page != currentPage}"
                                   th:href="@{/staff/orders(page=${page}, size=20, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}"
                                   th:text="${page + 1}"
                                   class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                </a>
                                <span th:if="${page == currentPage}"
                                      th:text="${page + 1}"
                                      class="bg-primary-50 border-primary-500 text-primary-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                </span>
                            </span>
                            <a th:if="${currentPage < totalPages - 1}"
                               th:href="@{/staff/orders(page=${currentPage + 1}, size=20, sortBy=${sortBy}, sortDir=${sortDir}, status=${currentStatus}, search=${currentSearch})}"
                               class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Order Modal -->
<div id="viewOrderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-6 border w-full max-w-3xl shadow-lg rounded-lg bg-white">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Chi tiết đơn hàng</h3>
            <button type="button" class="text-gray-400 hover:text-gray-600" onclick="closeViewOrderModal()">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="orderDetailContent" class="space-y-4">
            <div class="text-gray-500 text-sm">Đang tải...</div>
        </div>
    </div>
    
    <script>
        function openViewOrderModal(orderId) {
            const modal = document.getElementById('viewOrderModal');
            const content = document.getElementById('orderDetailContent');
            content.innerHTML = '<div class="text-gray-500 text-sm">Đang tải...</div>';
            modal.classList.remove('hidden');

            fetch(`/api/staff/orders/${orderId}`)
                .then(r => r.json())
                .then(data => {
                    if (!data.success || !data.data) {
                        content.innerHTML = '<div class="text-red-600">Không tải được chi tiết đơn hàng</div>';
                        return;
                    }
                    const o = data.data;
                    content.innerHTML = renderOrderDetail(o);
                })
                .catch(() => {
                    content.innerHTML = '<div class="text-red-600">Có lỗi xảy ra</div>';
                });
        }

        function closeViewOrderModal() {
            document.getElementById('viewOrderModal').classList.add('hidden');
        }

        function renderOrderDetail(o) {
            const fmt = (v) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 }).format(v || 0).replace('₫', '₫');
            const statusMeta = {
                PENDING: 'Chờ xử lý',
                PROCESSING: 'Đang xử lý',
                SHIPPED: 'Đang giao',
                COMPLETED: 'Hoàn thành',
                CANCELLED: 'Đã hủy'
            };
            const currentStatus = (typeof o.status === 'string') ? o.status : (o.status && o.status.name ? o.status.name : '');
            const statusOptions = ['PENDING','PROCESSING','SHIPPED','COMPLETED','CANCELLED']
                .map(s => `<option value="${s}" ${currentStatus === s ? 'selected' : ''}>${statusMeta[s]}</option>`)
                .join('');

            const items = (o.items || []).map(it => `
                <div class="py-2 grid grid-cols-12 items-center">
                    <div class="col-span-6">
                        <div class="text-sm font-medium text-gray-900">${it.productName || ''}</div>
                        <div class="text-xs text-gray-500">${it.productSku || ''}</div>
                    </div>
                    <div class="col-span-2 text-center text-sm">${fmt(it.price)}</div>
                    <div class="col-span-2 text-center text-sm">${it.quantity}</div>
                    <div class="col-span-2 text-right text-sm">${fmt((it.price || 0) * (it.quantity || 0))}</div>
                </div>
            `).join('');

            return `
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-lg font-semibold text-gray-900">#${o.id || ''}</div>
                        <div class="text-sm text-gray-500">${o.orderDate || ''}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="modalNewStatus" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">${statusOptions}</select>
                        <button onclick="updateOrderStatusFromModal('${o.id}')" class="px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Cập nhật</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm font-medium text-gray-900 mb-2">Khách hàng</div>
                        <div class="text-sm text-gray-900">${o.userFullName || ''}</div>
                        <div class="text-xs text-gray-600">${o.userEmail || ''}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-sm font-medium text-gray-900 mb-2">Giao hàng</div>
                        <div class="text-sm text-gray-900">${o.addressDetails || ''}</div>
                        <div class="text-sm font-medium text-gray-900">SĐT nhận: ${o.userPhone || ''}</div>
                    </div>
                </div>
                <div class="bg-white rounded-lg border p-4">
                    <div class="grid grid-cols-12 text-xs font-medium text-gray-500 py-2">
                        <div class="col-span-6">Sản phẩm</div>
                        <div class="col-span-2 text-center">Giá</div>
                        <div class="col-span-2 text-center">SL</div>
                        <div class="col-span-2 text-right">Thành tiền</div>
                    </div>
                    <div class="divide-y divide-gray-100">${items || ''}</div>
                    <div class="pt-4 mt-2 border-t space-y-1 text-sm">
                        <div class="flex justify-between"><span class="text-gray-600">Tạm tính</span><span>${fmt(o.subtotal || 0)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Phí vận chuyển</span><span>${fmt(o.deliveryFee || o.shippingFee || 0)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Voucher</span><span>${o.voucherCode ? o.voucherCode : '-'}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Giảm giá</span><span class="text-green-600">-${fmt(o.discountAmount || 0)}</span></div>
                        <div class="flex justify-between font-semibold"><span>Tổng</span><span class="text-primary-600">${fmt(o.totalAmount)}</span></div>
                    </div>
                </div>
            `;
        }

        function updateOrderStatusFromModal(orderId) {
            const newStatus = document.getElementById('modalNewStatus').value;
            fetch(`/api/staff/orders/${orderId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    closeViewOrderModal();
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    alert(data.error || 'Có lỗi xảy ra');
                }
            })
            .catch(() => alert('Có lỗi xảy ra khi cập nhật trạng thái'));
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.view-order-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    openViewOrderModal(orderId);
                });
            });

            // Close when clicking outside modal content
            const modal = document.getElementById('viewOrderModal');
            if (modal) {
                modal.addEventListener('click', function(e){
                    if (e.target === modal) closeViewOrderModal();
                });
            }
        });
    </script>
</div>


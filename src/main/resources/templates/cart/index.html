<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layouts/main :: layout('Giỏ hàng - StarShop', 
          'Quản lý giỏ hàng của bạn', 
          ~{::link},
          ~{::content})}">

<head>
    <link rel="stylesheet" href="/css/cart.css">
</head>

<body>
<th:block th:fragment="content">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb" th:if="${breadcrumbs}">
                <li class="breadcrumb-item" th:each="breadcrumb : ${breadcrumbs}">
                    <a th:href="${breadcrumb.url}" th:text="${breadcrumb.title}" 
                       th:classappend="${breadcrumbStat.last} ? 'active' : ''"
                       class="breadcrumb-link"></a>
                </li>
            </ol>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <svg class="w-8 h-8 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M1 1.75A.75.75 0 0 1 1.75 1h1.628a1.75 1.75 0 0 1 1.734 1.51L5.18 3a65.25 65.25 0 0 1 13.36 1.412.75.75 0 0 1 .58.875 48.645 48.645 0 0 1-1.618 6.2.75.75 0 0 1-.712.513H6a2.503 2.503 0 0 0-2.292 1.5H17.25a.75.75 0 0 1 0 1.5H2.76a.75.75 0 0 1-.748-.807 4.002 4.002 0 0 1 2.716-3.486L3.626 2.716a.25.25 0 0 0-.248-.216H1.75A.75.75 0 0 1 1 1.75ZM6 17.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM15.5 19a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                    </svg>
                    Giỏ hàng của bạn
                </h2>
                
                <!-- Cart Items -->
                <div th:if="${cart != null and cart.items != null and !cart.items.isEmpty()}">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Sản phẩm</th>
                                            <th>Đơn giá</th>
                                            <th>Số lượng</th>
                                            <th>Thành tiền</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cartItems">
                                        <tr th:if="${cart != null and cart.items != null}" th:each="item : ${cart.items}" th:data-product-id="${item.productId}">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img th:src="${item.productImage != null ? item.productImage : '/images/placeholder-product.jpg'}" 
                                                         th:alt="${item.productName}" 
                                                         class="cart-item-image me-3">
                                                    <div>
                                                        <h6 class="mb-1" th:text="${item.productName}">Tên sản phẩm</h6>
                                                        <small class="text-muted" th:text="${item.productDescription}">Mô tả sản phẩm</small>
                                                        <br>
                                                        <small class="badge" 
                                                               th:classappend="${item.productStatus == 'ACTIVE' ? 'bg-success' : 'bg-danger'}"
                                                               th:text="${item.productStatus == 'ACTIVE' ? 'Còn hàng' : 'Hết hàng'}">
                                                            Trạng thái
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-primary" 
                                                      th:text="${item.productPrice != null ? #numbers.formatInteger(item.productPrice, 0, 'COMMA') + '₫' : 'Liên hệ'}">
                                                    0₫
                                                </span>
                                            </td>
                                            <td>
                                                <div class="quantity-controls">
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            onclick="updateQuantity(this, -1)"
                                                            th:data-product-id="${item.productId}">
                                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M4 10a.75.75 0 0 1 .75-.75h10.5a.75.75 0 0 1 0 1.5H4.75A.75.75 0 0 1 4 10Z" clip-rule="evenodd" />
                                                        </svg>
                                                    </button>
                                                    <input type="number" 
                                                           class="form-control quantity-input mx-2" 
                                                           th:value="${item.quantity}"
                                                           min="1" 
                                                           th:max="${item.productStockQuantity}"
                                                           th:data-product-id="${item.productId}"
                                                           onchange="updateQuantityDirect(this)">
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            onclick="updateQuantity(this, 1)"
                                                            th:data-product-id="${item.productId}">
                                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-success subtotal" 
                                                      th:text="${item.subtotal != null ? #numbers.formatInteger(item.subtotal, 0, 'COMMA') + '₫' : '0₫'}">
                                                    0₫
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="removeFromCart(this)"
                                                        th:data-product-id="${item.productId}">
                                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cart Summary -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-danger" onclick="clearCart()">
                                    <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                                    </svg>
                                    Xóa tất cả
                                </button>
                                <a href="/" class="btn btn-outline-primary">
                                    <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M17 10a.75.75 0 0 1-.75.75H5.612l4.158 3.96a.75.75 0 1 1-1.04 1.08l-5.5-5.25a.75.75 0 0 1 0-1.08l5.5-5.25a.75.75 0 1 1 1.04 1.08L5.612 9.25H16.25A.75.75 0 0 1 17 10Z" clip-rule="evenodd" />
                                    </svg>
                                    Tiếp tục mua sắm
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Tổng cong giỏ hàng</h5>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tổng số lượng:</span>
                                        <span id="totalQuantity" th:text="${cart != null and cart.totalQuantity != null ? cart.totalQuantity : 0}">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="fw-bold">Tổng tiền:</span>
                                        <span class="fw-bold text-success" id="totalAmount" 
                                              th:text="${cart != null and cart.totalAmount != null ? #numbers.formatInteger(cart.totalAmount, 0, 'COMMA') + '₫' : '0₫'}">
                                            0₫
                                        </span>
                                    </div>
                                    <button class="btn btn-success w-100" onclick="proceedToCheckout()">
                                        <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M2.5 4A1.5 1.5 0 0 0 1 5.5V6h18v-.5A1.5 1.5 0 0 0 17.5 4h-15ZM19 8.5H1v6A1.5 1.5 0 0 0 2.5 16h15a1.5 1.5 0 0 0 1.5-1.5v-6ZM3 13.25a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75Zm4.75-.75a.75.75 0 0 0 0 1.5h3.5a.75.75 0 0 0 0-1.5h-3.5Z" clip-rule="evenodd" />
                                        </svg>
                                        Thanh toán
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Empty Cart -->
                <div th:if="${cart == null or cart.items == null or cart.items.isEmpty()}" class="text-center py-5">
                    <div class="empty-cart">
                        <svg class="w-32 h-32 mx-auto text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M1 1.75A.75.75 0 0 1 1.75 1h1.628a1.75 1.75 0 0 1 1.734 1.51L5.18 3a65.25 65.25 0 0 1 13.36 1.412.75.75 0 0 1 .58.875 48.645 48.645 0 0 1-1.618 6.2.75.75 0 0 1-.712.513H6a2.503 2.503 0 0 0-2.292 1.5H17.25a.75.75 0 0 1 0 1.5H2.76a.75.75 0 0 1-.748-.807 4.002 4.002 0 0 1 2.716-3.486L3.626 2.716a.25.25 0 0 0-.248-.216H1.75A.75.75 0 0 1 1 1.75ZM6 17.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0ZM15.5 19a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                        </svg>
                        <h3 class="text-muted mb-3">Giỏ hàng trống</h3>
                        <p class="text-muted mb-4">Bạn chưa có sản phẩm nào trong giỏ hàng</p>
                        <a href="/" class="btn btn-primary">
                            <svg class="w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M1 2.75A.75.75 0 0 1 1.75 2h16.5a.75.75 0 0 1 0 1.5H18v8.75A2.75 2.75 0 0 1 15.25 15h-1.072l.798 3.06a.75.75 0 0 1-1.452.38L13.41 18H6.59l-.114.44a.75.75 0 0 1-1.452-.38L5.823 15H4.75A2.75 2.75 0 0 1 2 12.25V3.5h-.25A.75.75 0 0 1 1 2.75ZM7.373 15l-.391 1.5h6.037l-.392-1.5H7.373Zm7.49-8.931a.75.75 0 0 1-.175 1.046 19.326 19.326 0 0 0-3.398 3.098.75.75 0 0 1-1.097.04L8.5 8.561l-2.22 2.22A.75.75 0 1 1 5.22 9.72l2.75-2.75a.75.75 0 0 1 1.06 0l1.664 1.663a20.786 20.786 0 0 1 3.122-2.74.75.75 0 0 1 1.046.176Z" clip-rule="evenodd" />
                            </svg>
                            Bắt đầu mua sắm
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cart JavaScript -->
    <script>
        // Update quantity
        function updateQuantity(button, change) {
            const productId = button.dataset.productId;
            const row = button.closest('tr');
            const quantityInput = row.querySelector('.quantity-input');
            const currentQuantity = parseInt(quantityInput.value);
            const newQuantity = Math.max(1, currentQuantity + change);
            
            quantityInput.value = newQuantity;
            updateCartItem(productId, newQuantity);
        }
        
        // Update quantity directly from input
        function updateQuantityDirect(input) {
            const productId = input.dataset.productId;
            const quantity = Math.max(1, parseInt(input.value) || 1);
            input.value = quantity;
            updateCartItem(productId, quantity);
        }
        
        // Update cart item via API
        function updateCartItem(productId, quantity) {
            const csrfToken = getCsrfToken();
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            fetch('/api/cart/update', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [csrfHeader]: csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({ productId: parseInt(productId), quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.data && data.data.success) {
                    // Reload page to show updated cart
                    location.reload();
                } else {
                    showToast(data.error || data.message || 'Có lỗi xảy ra khi cập nhật giỏ hàng', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating cart:', error);
                showToast('Có lỗi xảy ra khi cập nhật giỏ hàng', 'error');
            });
        }
        
        // Remove from cart
        function removeFromCart(button) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                return;
            }
            
            const productId = button.dataset.productId;
            const csrfToken = getCsrfToken();
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            fetch('/api/cart/remove', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [csrfHeader]: csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({ productId: parseInt(productId) })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.data && data.data.success) {
                    showToast(data.data.message || 'Đã xóa sản phẩm khỏi giỏ hàng', 'success');
                    // Reload page to show updated cart
                    location.reload();
                } else {
                    showToast(data.error || data.message || 'Có lỗi xảy ra khi xóa sản phẩm', 'error');
                }
            })
            .catch(error => {
                console.error('Error removing from cart:', error);
                showToast('Có lỗi xảy ra khi xóa sản phẩm khỏi giỏ hàng', 'error');
            });
        }
        
        // Clear cart
        function clearCart() {
            if (!confirm('Bạn có chắc muốn xóa tất cả sản phẩm khỏi giỏ hàng?')) {
                return;
            }
            
            const csrfToken = getCsrfToken();
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            fetch('/api/cart/clear', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [csrfHeader]: csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.data && data.data.success) {
                    showToast(data.data.message || 'Đã xóa tất cả sản phẩm khỏi giỏ hàng', 'success');
                    location.reload();
                } else {
                    showToast(data.error || data.message || 'Có lỗi xảy ra khi xóa giỏ hàng', 'error');
                }
            })
            .catch(error => {
                console.error('Error clearing cart:', error);
                showToast('Có lỗi xảy ra khi xóa giỏ hàng', 'error');
            });
        }
        
        // Proceed to checkout
        function proceedToCheckout() {
            window.location.href = '/checkout';
        }
        
        // Get CSRF token
        function getCsrfToken() {
            // Try to get from cookie first
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'XSRF-TOKEN') {
                    return decodeURIComponent(value);
                }
            }
            
            // Fallback to meta tag
            const token = document.querySelector('meta[name="_csrf"]');
            return token ? token.getAttribute('content') : '';
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</th:block>
</body>
</html>

<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - StarShop</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    
    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
    <!-- Header -->
    <div th:replace="~{fragments/header :: header}"></div>
    
    <!-- Breadcrumb -->
    <div th:replace="~{fragments/breadcrumb :: breadcrumb}"></div>
    
    <!-- Main Content -->
    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="bi bi-cart3"></i> Giỏ hàng của bạn
                </h2>
                
                <!-- Cart Items -->
                <div th:if="${cart != null and cart.items != null and !cart.items.isEmpty()}">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Sản phẩm</th>
                                            <th>Đơn giá</th>
                                            <th>Số lượng</th>
                                            <th>Thành tiền</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cartItems">
                                        <tr th:if="${cart != null and cart.items != null}" th:each="item : ${cart.items}" th:data-product-id="${item.productId}">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img th:src="${item.productImage != null ? item.productImage : '/images/placeholder-product.jpg'}" 
                                                         th:alt="${item.productName}" 
                                                         class="cart-item-image me-3">
                                                    <div>
                                                        <h6 class="mb-1" th:text="${item.productName}">Tên sản phẩm</h6>
                                                        <small class="text-muted" th:text="${item.productDescription}">Mô tả sản phẩm</small>
                                                        <br>
                                                        <small class="badge" 
                                                               th:classappend="${item.productStatus == 'ACTIVE' ? 'bg-success' : 'bg-danger'}"
                                                               th:text="${item.productStatus == 'ACTIVE' ? 'Còn hàng' : 'Hết hàng'}">
                                                            Trạng thái
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-primary" 
                                                      th:text="${item.productPrice != null ? #numbers.formatInteger(item.productPrice, 0, 'COMMA') + '₫' : 'Liên hệ'}">
                                                    0₫
                                                </span>
                                            </td>
                                            <td>
                                                <div class="quantity-controls">
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            onclick="updateQuantity(this, -1)"
                                                            th:data-product-id="${item.productId}">
                                                        <i class="bi bi-dash"></i>
                                                    </button>
                                                    <input type="number" 
                                                           class="form-control quantity-input mx-2" 
                                                           th:value="${item.quantity}"
                                                           min="1" 
                                                           th:max="${item.productStockQuantity}"
                                                           th:data-product-id="${item.productId}"
                                                           onchange="updateQuantityDirect(this)">
                                                    <button class="btn btn-outline-secondary btn-sm" 
                                                            onclick="updateQuantity(this, 1)"
                                                            th:data-product-id="${item.productId}">
                                                        <i class="bi bi-plus"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-success subtotal" 
                                                      th:text="${item.subtotal != null ? #numbers.formatInteger(item.subtotal, 0, 'COMMA') + '₫' : '0₫'}">
                                                    0₫
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="removeFromCart(this)"
                                                        th:data-product-id="${item.productId}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cart Summary -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-danger" onclick="clearCart()">
                                    <i class="bi bi-trash"></i> Xóa tất cả
                                </button>
                                <a href="/" class="btn btn-outline-primary">
                                    <i class="bi bi-arrow-left"></i> Tiếp tục mua sắm
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Tổng cong giỏ hàng</h5>
                                    <hr>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tổng số lượng:</span>
                                        <span id="totalQuantity" th:text="${cart != null and cart.totalQuantity != null ? cart.totalQuantity : 0}">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="fw-bold">Tổng tiền:</span>
                                        <span class="fw-bold text-success" id="totalAmount" 
                                              th:text="${cart != null and cart.totalAmount != null ? #numbers.formatInteger(cart.totalAmount, 0, 'COMMA') + '₫' : '0₫'}">
                                            0₫
                                        </span>
                                    </div>
                                    <button class="btn btn-success w-100" onclick="proceedToCheckout()">
                                        <i class="bi bi-credit-card"></i> Thanh toán
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Empty Cart -->
                <div th:if="${cart == null or cart.items == null or cart.items.isEmpty()}" class="text-center py-5">
                    <div class="empty-cart">
                        <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
                        <h3 class="text-muted mb-3">Giỏ hàng trống</h3>
                        <p class="text-muted mb-4">Bạn chưa có sản phẩm nào trong giỏ hàng</p>
                        <a href="/" class="btn btn-primary">
                            <i class="bi bi-shop"></i> Bắt đầu mua sắm
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script th:src="@{/js/main.js}"></script>
    
    <script>
        // Update quantity
        function updateQuantity(button, change) {
            const productId = button.dataset.productId;
            const row = button.closest('tr');
            const quantityInput = row.querySelector('.quantity-input');
            const currentQuantity = parseInt(quantityInput.value);
            const newQuantity = Math.max(1, currentQuantity + change);
            
            quantityInput.value = newQuantity;
            updateCartItem(productId, newQuantity);
        }
        
        // Update quantity directly from input
        function updateQuantityDirect(input) {
            const productId = input.dataset.productId;
            const quantity = Math.max(1, parseInt(input.value) || 1);
            input.value = quantity;
            updateCartItem(productId, quantity);
        }
        
        // Update cart item via API
        function updateCartItem(productId, quantity) {
            const csrfToken = getCsrfToken();
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            fetch('/api/cart/update', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [csrfHeader]: csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({ productId: parseInt(productId), quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.data && data.data.success) {
                    // Reload page to show updated cart
                    location.reload();
                } else {
                    showToast(data.error || data.message || 'Có lỗi xảy ra khi cập nhật giỏ hàng', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating cart:', error);
                showToast('Có lỗi xảy ra khi cập nhật giỏ hàng', 'error');
            });
        }
        
        // Remove from cart
        function removeFromCart(button) {
            if (!confirm('Bạn có chắc muốn xóa sản phẩm này khỏi giỏ hàng?')) {
                return;
            }
            
            const productId = button.dataset.productId;
            const csrfToken = getCsrfToken();
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            fetch('/api/cart/remove', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [csrfHeader]: csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({ productId: parseInt(productId) })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.data && data.data.success) {
                    showToast(data.data.message || 'Đã xóa sản phẩm khỏi giỏ hàng', 'success');
                    // Reload page to show updated cart
                    location.reload();
                } else {
                    showToast(data.error || data.message || 'Có lỗi xảy ra khi xóa sản phẩm', 'error');
                }
            })
            .catch(error => {
                console.error('Error removing from cart:', error);
                showToast('Có lỗi xảy ra khi xóa sản phẩm khỏi giỏ hàng', 'error');
            });
        }
        
        // Clear cart
        function clearCart() {
            if (!confirm('Bạn có chắc muốn xóa tất cả sản phẩm khỏi giỏ hàng?')) {
                return;
            }
            
            const csrfToken = getCsrfToken();
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            fetch('/api/cart/clear', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [csrfHeader]: csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.data && data.data.success) {
                    showToast(data.data.message || 'Đã xóa tất cả sản phẩm khỏi giỏ hàng', 'success');
                    location.reload();
                } else {
                    showToast(data.error || data.message || 'Có lỗi xảy ra khi xóa giỏ hàng', 'error');
                }
            })
            .catch(error => {
                console.error('Error clearing cart:', error);
                showToast('Có lỗi xảy ra khi xóa giỏ hàng', 'error');
            });
        }
        
        // Proceed to checkout
        function proceedToCheckout() {
            // TODO: Implement checkout functionality
            showToast('Chức năng thanh toán đang được phát triển', 'info');
        }
        
        // Get CSRF token
        function getCsrfToken() {
            // Try to get from cookie first
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'XSRF-TOKEN') {
                    return decodeURIComponent(value);
                }
            }
            
            // Fallback to meta tag
            const token = document.querySelector('meta[name="_csrf"]');
            return token ? token.getAttribute('content') : '';
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>

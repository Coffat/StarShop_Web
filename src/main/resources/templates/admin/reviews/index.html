<!-- Admin Reviews Management Content -->
<div xmlns:th="http://www.thymeleaf.org" class="min-h-screen bg-gray-50">
    
    <!-- Page Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-star text-white text-xl"></i>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 mt-1">Theo d√µi v√† qu·∫£n l√Ω ƒë√°nh gi√° s·∫£n ph·∫©m c·ªßa kh√°ch h√†ng</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="refreshReviews()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                            <i class="fas fa-sync-alt mr-2"></i>
                            L√†m m·ªõi
                        </button>
                        <button onclick="exportReviews()" class="inline-flex items-center px-4 py-2 bg-indigo-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                            <i class="fas fa-download mr-2"></i>
                            Xu·∫•t Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Reviews -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-comments text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">T·ªïng ƒë√°nh gi√°</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalReviews">0</p>
                    </div>
                </div>
            </div>

            <!-- Average Rating -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-star text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">ƒê√°nh gi√° trung b√¨nh</p>
                        <p class="text-2xl font-bold text-gray-900" id="averageRating">0.0</p>
                    </div>
                </div>
            </div>

            <!-- 5 Star Reviews -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-thumbs-up text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">ƒê√°nh gi√° 5 sao</p>
                        <p class="text-2xl font-bold text-gray-900" id="fiveStarReviews">0</p>
                    </div>
                </div>
            </div>

            <!-- Recent Reviews -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-purple-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">ƒê√°nh gi√° h√¥m nay</p>
                        <p class="text-2xl font-bold text-gray-900" id="todayReviews">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Rating Filter -->
                <div>
                    <label for="ratingFilter" class="block text-sm font-medium text-gray-700 mb-2">L·ªçc theo ƒë√°nh gi√°</label>
                    <select id="ratingFilter" onchange="filterReviews()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="">T·∫•t c·∫£ ƒë√°nh gi√°</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 sao</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 sao</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê 3 sao</option>
                        <option value="2">‚≠ê‚≠ê 2 sao</option>
                        <option value="1">‚≠ê 1 sao</option>
                    </select>
                </div>

                <!-- Search -->
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-2">T√¨m ki·∫øm</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="T√™n s·∫£n ph·∫©m, ng∆∞·ªùi d√πng..." 
                               onkeyup="searchReviews()" 
                               class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <!-- Sort -->
                <div>
                    <label for="sortBy" class="block text-sm font-medium text-gray-700 mb-2">S·∫Øp x·∫øp</label>
                    <select id="sortBy" onchange="filterReviews()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="newest">M·ªõi nh·∫•t</option>
                        <option value="oldest">C≈© nh·∫•t</option>
                        <option value="rating-high">ƒê√°nh gi√° cao</option>
                        <option value="rating-low">ƒê√°nh gi√° th·∫•p</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">Tr·∫°ng th√°i</label>
                    <select id="statusFilter" onchange="filterReviews()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="verified">ƒê√£ x√°c minh</option>
                        <option value="unverified">Ch∆∞a x√°c minh</option>
                    </select>
                </div>

                <!-- Sentiment Filter -->
                <div>
                    <label for="sentimentFilter" class="block text-sm font-medium text-gray-700 mb-2">Ph√¢n lo·∫°i</label>
                    <select id="sentimentFilter" onchange="filterReviews()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="POSITIVE">T√≠ch c·ª±c üòä</option>
                        <option value="NEUTRAL">Trung t√≠nh üòê</option>
                        <option value="NEGATIVE">Ti√™u c·ª±c üò°</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Reviews Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Loading State -->
            <div id="loadingState" class="p-12 text-center">
                <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-indigo-500 bg-indigo-100">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ƒêang t·∫£i ƒë√°nh gi√°...
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="p-12 text-center" style="display: none;">
                <div class="mx-auto h-24 w-24 text-gray-400 mb-4">
                    <i class="fas fa-star text-6xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</h3>
                <p class="text-gray-500">Kh√°ch h√†ng ch∆∞a ƒë√°nh gi√° s·∫£n ph·∫©m n√†o.</p>
            </div>

            <!-- Reviews Table -->
            <div id="reviewsTable" style="display: none;">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ng∆∞·ªùi d√πng</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">S·∫£n ph·∫©m</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ƒê√°nh gi√°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">B√¨nh lu·∫≠n</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ph·∫£n h·ªìi Admin</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ng√†y t·∫°o</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tr·∫°ng th√°i</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="reviewsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Reviews will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        <button onclick="previousPage()" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Tr∆∞·ªõc
                        </button>
                        <button onclick="nextPage()" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Sau
                        </button>
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700" id="paginationInfo">
                                Hi·ªÉn th·ªã <span class="font-medium">1</span> ƒë·∫øn <span class="font-medium">10</span> 
                                trong t·ªïng s·ªë <span class="font-medium">0</span> k·∫øt qu·∫£
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" id="pagination">
                                <!-- Pagination will be generated here -->
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mt-4">X√°c nh·∫≠n x√≥a</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë√°nh gi√° n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        X√≥a
                    </button>
                    <button onclick="cancelDelete()" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-24 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        H·ªßy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Response Modal -->
    <div id="adminResponseModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-2/3 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" id="adminResponseModalTitle">Th√™m ph·∫£n h·ªìi</h3>
                    <button onclick="closeAdminResponseModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label for="adminResponseText" class="block text-sm font-medium text-gray-700 mb-2">N·ªôi dung ph·∫£n h·ªìi</label>
                    <textarea id="adminResponseText" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                              placeholder="Nh·∫≠p ph·∫£n h·ªìi c·ªßa b·∫°n..."></textarea>
                    <div class="text-xs text-gray-500 mt-1">
                        <span id="adminResponseCharCount">0</span>/1000 k√Ω t·ª±
                    </div>
                </div>
                
                <!-- AI Assistant Box -->
                <div id="aiAssistBox" style="display: none;" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fas fa-robot text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-3 flex-1">
                            <h4 class="text-sm font-semibold text-blue-900 mb-2">AI H·ªó tr·ª£</h4>
                            <div id="aiMainIssue" class="text-sm text-blue-800 mb-3"></div>
                            <div id="aiSuggestedReplies" class="space-y-2"></div>
                            <div id="aiLoadingIndicator" style="display: none;" class="flex items-center text-blue-600">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span class="text-sm">ƒêang ph√¢n t√≠ch...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="closeAdminResponseModal()" class="px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        H·ªßy
                    </button>
                    <button onclick="saveAdminResponse()" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <span id="adminResponseSaveText">L∆∞u ph·∫£n h·ªìi</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <div class="bg-white border-l-4 border-green-400 p-4 shadow-lg rounded-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900" id="toastMessage">Th√†nh c√¥ng!</p>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// Global variables
let currentPage = 0;
let pageSize = 20;
let currentRating = '';
let currentSearch = '';
let currentStatus = '';
let currentSentiment = '';
let currentSort = 'newest';
let deleteReviewId = null;
let currentAdminResponseReviewId = null;
let isEditingAdminResponse = false;
let currentAiAnalysis = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadReviews();
    
    // Setup character counter for admin response
    const adminResponseText = document.getElementById('adminResponseText');
    const charCount = document.getElementById('adminResponseCharCount');
    
    adminResponseText.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        if (count > 1000) {
            charCount.classList.add('text-red-500');
            charCount.classList.remove('text-gray-500');
        } else {
            charCount.classList.remove('text-red-500');
            charCount.classList.add('text-gray-500');
        }
    });
});

// Load statistics
async function loadStatistics() {
    try {
        const response = await fetch('/admin/api/reviews/statistics');
        const data = await response.json();
        
        if (data.success && data.data) {
            document.getElementById('totalReviews').textContent = data.data.totalReviews || 0;
            document.getElementById('averageRating').textContent = (data.data.averageRating || 0).toFixed(1);
            document.getElementById('fiveStarReviews').textContent = data.data.fiveStarReviews || 0;
            document.getElementById('todayReviews').textContent = data.data.todayReviews || 0;
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Load reviews from API
async function loadReviews() {
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const reviewsTable = document.getElementById('reviewsTable');
    
    loadingState.style.display = 'block';
    emptyState.style.display = 'none';
    reviewsTable.style.display = 'none';
    
    try {
        let url = `/admin/api/reviews?page=${currentPage}&size=${pageSize}`;
        if (currentRating) url += `&rating=${currentRating}`;
        if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;
        if (currentStatus) url += `&status=${currentStatus}`;
        if (currentSentiment) url += `&sentiment=${currentSentiment}`;
        if (currentSort) url += `&sort=${currentSort}`;
        
        console.log('Loading reviews with URL:', url);
        console.log('Current sort value:', currentSort);
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.data.content && data.data.content.length > 0) {
            renderReviewsTable(data.data);
            renderPagination(data.data);
            reviewsTable.style.display = 'block';
        } else {
            emptyState.style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading reviews:', error);
        emptyState.style.display = 'block';
    } finally {
        loadingState.style.display = 'none';
    }
}

// Render reviews table
function renderReviewsTable(reviewsPage) {
    const tbody = document.getElementById('reviewsTableBody');
    tbody.innerHTML = '';
    
    reviewsPage.content.forEach(review => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-150';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center">
                            <span class="text-sm font-medium text-white">${review.userName ? review.userName.charAt(0).toUpperCase() : 'U'}</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">${review.userName || 'Unknown'}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${review.productName || 'Unknown'}</div>
                <div class="text-sm text-gray-500">ID: ${review.productId || 'N/A'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    ${generateStars(review.rating)}
                    <span class="ml-2 text-sm font-medium text-gray-900">${review.rating}/5</span>
                </div>
                ${review.sentiment ? 
                    `<div class="mt-1">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${getSentimentBadgeClass(review.sentiment)}">
                            ${getSentimentLabel(review.sentiment)}
                        </span>
                    </div>` : 
                    ''
                }
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900 max-w-xs">
                    ${review.comment ? 
                        `<div class="truncate" title="${review.comment}">${review.comment}</div>` : 
                        '<span class="text-gray-400 italic">Kh√¥ng c√≥ b√¨nh lu·∫≠n</span>'
                    }
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900 max-w-xs">
                    ${review.adminResponse ? 
                        `<div class="bg-blue-50 p-2 rounded-lg">
                            <div class="text-blue-800 text-xs font-medium mb-1">Ph·∫£n h·ªìi t·ª´ Admin</div>
                            <div class="text-blue-700 truncate" title="${review.adminResponse}">${review.adminResponse}</div>
                            ${review.adminResponseByName ? `<div class="text-blue-600 text-xs mt-1">- ${review.adminResponseByName}</div>` : ''}
                        </div>` : 
                        '<span class="text-gray-400 italic">Ch∆∞a c√≥ ph·∫£n h·ªìi</span>'
                    }
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div>${formatDate(review.createdAt)}</div>
                <div class="text-xs">${formatTime(review.createdAt)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${review.verified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                    <i class="fas ${review.verified ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-1"></i>
                    ${review.verified ? 'ƒê√£ x√°c minh' : 'Ch∆∞a x√°c minh'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex items-center space-x-2">
                    <button onclick="viewReview(${review.id})" class="text-indigo-600 hover:text-indigo-900 transition-colors duration-150" title="Xem chi ti·∫øt">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${review.adminResponse ? 
                        `<button onclick="editAdminResponse(${review.id}, '${review.adminResponse.replace(/'/g, "\\'")}')" class="text-blue-600 hover:text-blue-900 transition-colors duration-150" title="S·ª≠a ph·∫£n h·ªìi">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="removeAdminResponse(${review.id})" class="text-orange-600 hover:text-orange-900 transition-colors duration-150" title="X√≥a ph·∫£n h·ªìi">
                            <i class="fas fa-times"></i>
                        </button>` :
                        `<button onclick="addAdminResponse(${review.id})" class="text-green-600 hover:text-green-900 transition-colors duration-150" title="Th√™m ph·∫£n h·ªìi">
                            <i class="fas fa-reply"></i>
                        </button>`
                    }
                    <button onclick="deleteReview(${review.id})" class="text-red-600 hover:text-red-900 transition-colors duration-150" title="X√≥a ƒë√°nh gi√°">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Generate star rating display
function generateStars(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<i class="fas fa-star text-yellow-400"></i>';
        } else {
            stars += '<i class="far fa-star text-gray-300"></i>';
        }
    }
    return stars;
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

// Format time
function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
}

// Render pagination
function renderPagination(reviewsPage) {
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Update pagination info
    const start = reviewsPage.number * reviewsPage.size + 1;
    const end = Math.min((reviewsPage.number + 1) * reviewsPage.size, reviewsPage.totalElements);
    paginationInfo.innerHTML = `
        Hi·ªÉn th·ªã <span class="font-medium">${start}</span> ƒë·∫øn <span class="font-medium">${end}</span> 
        trong t·ªïng s·ªë <span class="font-medium">${reviewsPage.totalElements}</span> k·∫øt qu·∫£
    `;
    
    // Generate pagination buttons
    pagination.innerHTML = '';
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevButton.className = `relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${!reviewsPage.hasPrevious ? 'opacity-50 cursor-not-allowed' : ''}`;
    prevButton.onclick = () => reviewsPage.hasPrevious && goToPage(reviewsPage.number - 1);
    prevButton.disabled = !reviewsPage.hasPrevious;
    pagination.appendChild(prevButton);
    
    // Page numbers
    const startPage = Math.max(0, reviewsPage.number - 2);
    const endPage = Math.min(reviewsPage.totalPages - 1, reviewsPage.number + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i + 1;
        pageButton.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${i === reviewsPage.number ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`;
        pageButton.onclick = () => goToPage(i);
        pagination.appendChild(pageButton);
    }
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextButton.className = `relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 ${!reviewsPage.hasNext ? 'opacity-50 cursor-not-allowed' : ''}`;
    nextButton.onclick = () => reviewsPage.hasNext && goToPage(reviewsPage.number + 1);
    nextButton.disabled = !reviewsPage.hasNext;
    pagination.appendChild(nextButton);
}

// Filter functions
function filterReviews() {
    currentRating = document.getElementById('ratingFilter').value;
    currentStatus = document.getElementById('statusFilter').value;
    currentSentiment = document.getElementById('sentimentFilter').value;
    currentSort = document.getElementById('sortBy').value;
    currentPage = 0;
    
    console.log('Filter/Sort changed:', {
        rating: currentRating,
        status: currentStatus,
        sentiment: currentSentiment,
        sort: currentSort,
        page: currentPage
    });
    
    loadReviews();
}

function searchReviews() {
    currentSearch = document.getElementById('searchInput').value;
    currentSort = document.getElementById('sortBy').value;
    currentPage = 0;
    loadReviews();
}

// Pagination functions
function goToPage(page) {
    currentPage = page;
    loadReviews();
}

function previousPage() {
    if (currentPage > 0) {
        currentPage--;
        loadReviews();
    }
}

function nextPage() {
    currentPage++;
    loadReviews();
}

// Action functions
function viewReview(reviewId) {
    // Implementation for viewing review details
    showToast('Xem chi ti·∫øt ƒë√°nh gi√°: ' + reviewId);
}

function deleteReview(reviewId) {
    deleteReviewId = reviewId;
    document.getElementById('deleteModal').style.display = 'block';
}

function confirmDelete() {
    if (deleteReviewId) {
        // Implementation for deleting review
        showToast('ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng');
        document.getElementById('deleteModal').style.display = 'none';
        loadReviews();
        deleteReviewId = null;
    }
}

function cancelDelete() {
    document.getElementById('deleteModal').style.display = 'none';
    deleteReviewId = null;
}

function refreshReviews() {
    loadStatistics();
    loadReviews();
    showToast('ƒê√£ l√†m m·ªõi danh s√°ch ƒë√°nh gi√°');
}

function exportReviews() {
    showToast('ƒêang xu·∫•t file Excel...');
    // Implementation for Excel export
}

// Utility functions
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    
    // Update toast styling based on type
    const toastContainer = toast.querySelector('div');
    if (type === 'error') {
        toastContainer.className = 'bg-white border-l-4 border-red-400 p-4 shadow-lg rounded-lg';
        toastContainer.querySelector('i').className = 'fas fa-exclamation-circle text-red-400';
    } else {
        toastContainer.className = 'bg-white border-l-4 border-green-400 p-4 shadow-lg rounded-lg';
        toastContainer.querySelector('i').className = 'fas fa-check-circle text-green-400';
    }
    
    toast.classList.remove('translate-x-full');
    
    setTimeout(() => {
        toast.classList.add('translate-x-full');
    }, 3000);
}

// Admin Response Functions
function addAdminResponse(reviewId) {
    currentAdminResponseReviewId = reviewId;
    isEditingAdminResponse = false;
    
    document.getElementById('adminResponseModalTitle').textContent = 'Th√™m ph·∫£n h·ªìi';
    document.getElementById('adminResponseSaveText').textContent = 'L∆∞u ph·∫£n h·ªìi';
    document.getElementById('adminResponseText').value = '';
    document.getElementById('adminResponseCharCount').textContent = '0';
    document.getElementById('adminResponseCharCount').classList.remove('text-red-500');
    document.getElementById('adminResponseCharCount').classList.add('text-gray-500');
    
    document.getElementById('adminResponseModal').style.display = 'block';
    
    // Auto-fetch AI analysis when modal opens
    fetchAiAnalysis(reviewId);
}

function editAdminResponse(reviewId, currentResponse) {
    currentAdminResponseReviewId = reviewId;
    isEditingAdminResponse = true;
    
    document.getElementById('adminResponseModalTitle').textContent = 'S·ª≠a ph·∫£n h·ªìi';
    document.getElementById('adminResponseSaveText').textContent = 'C·∫≠p nh·∫≠t ph·∫£n h·ªìi';
    document.getElementById('adminResponseText').value = currentResponse;
    
    const count = currentResponse.length;
    document.getElementById('adminResponseCharCount').textContent = count;
    if (count > 1000) {
        document.getElementById('adminResponseCharCount').classList.add('text-red-500');
        document.getElementById('adminResponseCharCount').classList.remove('text-gray-500');
    } else {
        document.getElementById('adminResponseCharCount').classList.remove('text-red-500');
        document.getElementById('adminResponseCharCount').classList.add('text-gray-500');
    }
    
    document.getElementById('adminResponseModal').style.display = 'block';
    
    // Auto-fetch AI analysis when modal opens
    fetchAiAnalysis(reviewId);
}

function closeAdminResponseModal() {
    document.getElementById('adminResponseModal').style.display = 'none';
    document.getElementById('aiAssistBox').style.display = 'none';
    currentAdminResponseReviewId = null;
    isEditingAdminResponse = false;
    currentAiAnalysis = null;
}

async function saveAdminResponse() {
    const responseText = document.getElementById('adminResponseText').value.trim();
    
    if (!responseText) {
        showToast('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi', 'error');
        return;
    }
    
    if (responseText.length > 1000) {
        showToast('Ph·∫£n h·ªìi kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 1000 k√Ω t·ª±', 'error');
        return;
    }
    
    try {
        const url = isEditingAdminResponse ? 
            `/admin/api/reviews/${currentAdminResponseReviewId}/response` :
            `/admin/api/reviews/${currentAdminResponseReviewId}/respond`;
        
        const method = isEditingAdminResponse ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                adminResponse: responseText
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(isEditingAdminResponse ? 'Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng' : 'Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng');
            closeAdminResponseModal();
            loadReviews();
        } else {
            showToast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
        }
    } catch (error) {
        console.error('Error saving admin response:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi l∆∞u ph·∫£n h·ªìi', 'error');
    }
}

async function removeAdminResponse(reviewId) {
    let confirmed = false;
    if (typeof confirmDelete === 'function') {
        confirmed = await confirmDelete('X√≥a ph·∫£n h·ªìi?', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph·∫£n h·ªìi n√†y?');
    } else {
        confirmed = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph·∫£n h·ªìi n√†y?');
    }
    if (!confirmed) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/reviews/${reviewId}/response`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng');
            loadReviews();
        } else {
            showToast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
        }
    } catch (error) {
        console.error('Error removing admin response:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi x√≥a ph·∫£n h·ªìi', 'error');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const deleteModal = document.getElementById('deleteModal');
    const adminResponseModal = document.getElementById('adminResponseModal');
    
    if (event.target === deleteModal) {
        deleteModal.style.display = 'none';
    }
    
    if (event.target === adminResponseModal) {
        closeAdminResponseModal();
    }
}

// AI Analysis Functions
async function fetchAiAnalysis(reviewId) {
    const aiBox = document.getElementById('aiAssistBox');
    const loadingIndicator = document.getElementById('aiLoadingIndicator');
    
    aiBox.style.display = 'block';
    loadingIndicator.style.display = 'block';
    
    try {
        const response = await fetch(`/admin/api/reviews/${reviewId}/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const data = await response.json();
        
        if (data.success && data.data) {
            currentAiAnalysis = data.data;
            renderAiSuggestions(data.data);
        } else {
            console.error('AI analysis failed:', data.message);
            aiBox.style.display = 'none';
        }
    } catch (error) {
        console.error('AI analysis failed:', error);
        aiBox.style.display = 'none';
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

function renderAiSuggestions(analysis) {
    const mainIssueDiv = document.getElementById('aiMainIssue');
    const suggestedRepliesDiv = document.getElementById('aiSuggestedReplies');
    
    // Render main issue
    if (analysis.mainIssue) {
        mainIssueDiv.innerHTML = `<strong>T√≥m t·∫Øt v·∫•n ƒë·ªÅ:</strong> ${analysis.mainIssue}`;
    } else {
        mainIssueDiv.innerHTML = '';
    }
    
    // Render suggested replies
    suggestedRepliesDiv.innerHTML = '';
    
    if (analysis.suggestedReplies && analysis.suggestedReplies.length > 0) {
        analysis.suggestedReplies.forEach((reply, index) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'w-full text-left p-3 bg-white border border-blue-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors duration-150';
            button.innerHTML = `
                <div class="font-medium text-blue-900 mb-1">${reply.label}</div>
                <div class="text-sm text-blue-700">${reply.content}</div>
            `;
            button.onclick = () => {
                document.getElementById('adminResponseText').value = reply.content;
                // Update character count
                const count = reply.content.length;
                document.getElementById('adminResponseCharCount').textContent = count;
                if (count > 1000) {
                    document.getElementById('adminResponseCharCount').classList.add('text-red-500');
                    document.getElementById('adminResponseCharCount').classList.remove('text-gray-500');
                } else {
                    document.getElementById('adminResponseCharCount').classList.remove('text-red-500');
                    document.getElementById('adminResponseCharCount').classList.add('text-gray-500');
                }
            };
            suggestedRepliesDiv.appendChild(button);
        });
        
        // Add regenerate button
        const regenerateButton = document.createElement('button');
        regenerateButton.type = 'button';
        regenerateButton.className = 'mt-2 px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors duration-150';
        regenerateButton.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>T·∫°o th√™m g·ª£i √Ω';
        regenerateButton.onclick = () => {
            if (currentAdminResponseReviewId) {
                fetchAiAnalysis(currentAdminResponseReviewId);
            }
        };
        suggestedRepliesDiv.appendChild(regenerateButton);
    } else {
        suggestedRepliesDiv.innerHTML = '<div class="text-sm text-blue-600 italic">Kh√¥ng c√≥ g·ª£i √Ω n√†o</div>';
    }
}

// Sentiment helper functions
function getSentimentLabel(sentiment) {
    switch (sentiment) {
        case 'POSITIVE':
            return 'T√≠ch c·ª±c üòä';
        case 'NEUTRAL':
            return 'Trung t√≠nh üòê';
        case 'NEGATIVE':
            return 'Ti√™u c·ª±c üò°';
        default:
            return 'Kh√¥ng x√°c ƒë·ªãnh';
    }
}

function getSentimentBadgeClass(sentiment) {
    switch (sentiment) {
        case 'POSITIVE':
            return 'bg-green-100 text-green-800';
        case 'NEUTRAL':
            return 'bg-gray-100 text-gray-800';
        case 'NEGATIVE':
            return 'bg-red-100 text-red-800';
        default:
            return 'bg-gray-100 text-gray-800';
    }
}
</script>